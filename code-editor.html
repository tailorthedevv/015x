<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Code Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.1.1",
        "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
        "react/": "https://aistudiocdn.com/react@^19.1.1/",
        "@monaco-editor/react": "https://aistudiocdn.com/@monaco-editor/react@^4.7.0"
      }
    }
    </script>
  </head>
  <body class="bg-[#1e1e1e]">
    <div id="root"></div>
    <script type="module">
import React from 'react';
import ReactDOM from 'react-dom/client';
import Editor from '@monaco-editor/react';

const { useState, useEffect, useCallback, useMemo, useRef } = React;

const FileType = {
  HTML: 'html',
  CSS: 'css',
  JAVASCRIPT: 'javascript',
  PNG: 'png',
};

const ItemType = {
  FILE: 'file',
  FOLDER: 'folder',
};


const SAMPLE_IMAGE_BASE64 = 'iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAEKADAAQAAAABAAAAEAAAAAA0VXHyAAAAC0lEQVQ4EWNgwA/8Z+BgaAAA58sA/30RLS4AAAAASUVORK5CYII=';

const INITIAL_FILE_SYSTEM = {
  'root': { id: 'root', name: '015x.dev', parentId: null, type: ItemType.FOLDER, isOpen: true },
  'index.html': { 
    id: 'index.html', 
    name: 'index.html', 
    parentId: 'root',
    type: ItemType.FILE,
    language: FileType.HTML,
    content: `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Awesome Site</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Welcome to the Live Editor!</h1>
    <p>Change the code on the left to see it update here in real-time.</p>
    <button onclick="greet()">Click Me</button>
    <img src="/public/logo.png" alt="logo" width="50" />
    <script src="script.js"><\/script>
</body>
</html>
`
  },
  'style.css': {
    id: 'style.css',
    name: 'style.css',
    parentId: 'root',
    type: ItemType.FILE,
    language: FileType.CSS,
    content: `body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background-color: #f0f0f0;
    color: #333;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    box-sizing: border-box;
    margin: 0;
}

h1 {
    color: #007acc;
}

button {
    background-color: #007acc;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease;
}

button:hover {
    background-color: #005f9e;
}
`
  },
  'script.js': {
    id: 'script.js',
    name: 'script.js',
    parentId: 'root',
    type: ItemType.FILE,
    language: FileType.JAVASCRIPT,
    content: `console.log("Hello from script.js!");

function greet() {
    const heading = document.querySelector('h1');
    heading.textContent = 'Button Clicked! ðŸŽ‰';
    console.log('Button was clicked!');
    // This will cause an error to test the console
    // test.error(); 
}
`
  },
  'public': { id: 'public', name: 'public', parentId: 'root', type: ItemType.FOLDER, isOpen: true },
  'logo.png': {
    id: 'logo.png',
    name: 'logo.png',
    parentId: 'public',
    type: ItemType.FILE,
    language: FileType.PNG,
    content: SAMPLE_IMAGE_BASE64
  }
};
function useDebounce(value, delay) {
  const [debouncedValue, setDebouncedValue] = useState(value);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]);

  return debouncedValue;
}

const FileIcon = ({ type, className = 'w-5 h-5' }) => {
  switch (type) {
    case FileType.HTML:
      return React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", className: className, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
        React.createElement("path", { d: "M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" }), React.createElement("polyline", { points: "14 2 14 8 20 8" }), React.createElement("line", { x1: "16", y1: "13", x2: "8", y2: "13" }), React.createElement("line", { x1: "16", y1: "17", x2: "8", y2: "17" }), React.createElement("line", { x1: "10", y1: "9", x2: "8", y2: "9" }));
    case FileType.CSS:
      return React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", className: className, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
        React.createElement("path", { d: "M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" }), React.createElement("polyline", { points: "14 2 14 8 20 8" }), React.createElement("path", { d: "M12 18l-3-3 3-3 3 3-3 3z" }));
    case FileType.JAVASCRIPT:
      return React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", className: className, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
        React.createElement("path", { d: "M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" }), React.createElement("polyline", { points: "14 2 14 8 20 8" }), React.createElement("path", { d: "M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72" }), React.createElement("path", { d: "M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72" }));
     case FileType.PNG:
      return React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", className: `${className} text-purple-400`, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
        React.createElement("rect", { x: "3", y: "3", width: "18", height: "18", rx: "2", ry: "2" }), React.createElement("circle", { cx: "8.5", cy: "8.5", r: "1.5" }), React.createElement("polyline", { points: "21 15 16 10 5 21" }));
    default:
      return null;
  }
};
const FolderIcon = ({ className = 'w-4 h-4' }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 20 20", fill: "currentColor", className: `${className} text-neutral-400` }, React.createElement("path", { d: "M2 6a2 2 0 012-2h5l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" }));
const FolderOpenIcon = ({ className = 'w-4 h-4' }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 20 20", fill: "currentColor", className: `${className} text-neutral-400` }, React.createElement("path", { fillRule: "evenodd", d: "M2 6a2 2 0 012-2h5l2 2h6a2 2 0 012 2v2H2V6zm0 4v6a2 2 0 002 2h12a2 2 0 002-2V10H2z", clipRule: "evenodd" }));
const ChevronDownIcon = ({ className = 'w-4 h-4' }) => React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 20 20", fill: "currentColor", className: className }, React.createElement("path", { fillRule: "evenodd", d: "M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z", clipRule: "evenodd" }));
const CloseIcon = ({ className = 'w-4 h-4', onClick }) => React.createElement("svg", { onClick: onClick, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 20 20", fill: "currentColor", className: className }, React.createElement("path", { d: "M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" }));
const NewFileIcon = ({ className = 'w-5 h-5', onClick }) => React.createElement("svg", { onClick: onClick, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 20 20", fill: "currentColor", className: className }, React.createElement("path", { d: "M5.433 3.03A1.5 1.5 0 016.5 2h4.862a1.5 1.5 0 011.06.43l4.5 4.501a1.5 1.5 0 01.439 1.06V16.5a1.5 1.5 0 01-1.5 1.5H6.5A1.5 1.5 0 015 16.5v-13a1.5 1.5 0 01.433-1.03zM10 8a.75.75 0 01.75.75v2.5h2.5a.75.75 0 010 1.5h-2.5v2.5a.75.75 0 01-1.5 0v-2.5h-2.5a.75.75 0 010-1.5h2.5v-2.5A.75.75 0 0110 8z" }));
const NewFolderIcon = ({ className = 'w-5 h-5', onClick }) => React.createElement("svg", { onClick: onClick, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 20 20", fill: "currentColor", className: className }, React.createElement("path", { d: "M3.75 3A1.75 1.75 0 002 4.75v10.5c0 .966.784 1.75 1.75 1.75h12.5A1.75 1.75 0 0018 15.25v-8.5A1.75 1.75 0 0016.25 5h-4.836a.25.25 0 01-.177-.073L9.823 3.553A1.75 1.75 0 008.586 3H3.75zM10 8a.75.75 0 01.75.75v2.5h2.5a.75.75 0 010 1.5h-2.5v2.5a.75.75 0 01-1.5 0v-2.5h-2.5a.75.75 0 010-1.5h2.5v-2.5A.75.75 0 0110 8z" }));
const EditIcon = ({ className = 'w-4 h-4', onClick }) => React.createElement("svg", { onClick: onClick, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 20 20", fill: "currentColor", className: className }, React.createElement("path", { d: "M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" }), React.createElement("path", { fillRule: "evenodd", d: "M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z", clipRule: "evenodd" }));
const DeleteIcon = ({ className = 'w-4 h-4', onClick }) => React.createElement("svg", { onClick: onClick, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 20 20", fill: "currentColor", className: className }, React.createElement("path", { fillRule: "evenodd", d: "M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z", clipRule: "evenodd" }));


const ResizablePanel = ({ children, direction, initialSize = 50, minSize = 10, maxSize = 90, onResizeStart, onResizeEnd }) => {
  const [isDragging, setIsDragging] = useState(false);
  const [size, setSize] = useState(initialSize);
  const containerRef = useRef(null);

  const isHorizontal = direction === 'horizontal';

  const handleMouseDown = useCallback((e) => {
    e.preventDefault();
    setIsDragging(true);
    onResizeStart?.();
  }, [onResizeStart]);

  const handleMouseUp = useCallback(() => {
    setIsDragging(false);
    onResizeEnd?.();
  }, [onResizeEnd]);

  const handleMouseMove = useCallback((e) => {
    if (isDragging && containerRef.current) {
      const bounds = containerRef.current.getBoundingClientRect();
      let newSize;
      if (isHorizontal) {
        newSize = ((e.clientX - bounds.left) / bounds.width) * 100;
      } else {
        newSize = ((e.clientY - bounds.top) / bounds.height) * 100;
      }
      
      if (newSize > minSize && newSize < maxSize) {
        setSize(newSize);
      }
    }
  }, [isDragging, isHorizontal, minSize, maxSize]);

  useEffect(() => {
    if (isDragging) {
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('mouseup', handleMouseUp);
    }
    return () => {
      window.removeEventListener('mousemove', handleMouseMove);
      window.removeEventListener('mouseup', handleMouseUp);
    };
  }, [isDragging, handleMouseMove, handleMouseUp]);
  
  const mainStyle = isHorizontal ? { width: `${size}%` } : { height: `${size}%` };
  const secondaryStyle = isHorizontal ? { width: `${100 - size}%` } : { height: `${100 - size}%` };

  return React.createElement("div", { ref: containerRef, className: `flex h-full w-full ${isHorizontal ? 'flex-row' : 'flex-col'}` },
    React.createElement("div", { style: mainStyle, className: "overflow-hidden min-w-0 min-h-0" }, children[0]),
    React.createElement("div", { onMouseDown: handleMouseDown, className: `flex-shrink-0 bg-[#2c2c2c] hover:bg-[#007acc] transition-colors duration-200 ${isHorizontal ? 'w-1.5 cursor-col-resize' : 'h-1.5 cursor-row-resize'}` }),
    React.createElement("div", { style: secondaryStyle, className: "overflow-hidden min-w-0 min-h-0" }, children[1])
  );
};

const CodeEditor = ({ language, value, onChange }) => {
  const handleEditorChange = (value) => {
    onChange(value || '');
  };
  
  const handleEditorDidMount = (editor, monaco) => {
    editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
        console.log("Save action triggered");
    });
  };

  return React.createElement("div", { className: "h-full w-full" },
    React.createElement(Editor, {
      height: "100%",
      language: language === 'javascript' ? 'javascript' : language,
      value: value,
      theme: "vs-dark",
      onChange: handleEditorChange,
      onMount: handleEditorDidMount,
      options: {
        minimap: { enabled: true },
        fontSize: 14,
        wordWrap: 'on',
        scrollBeyondLastLine: false,
        automaticLayout: true,
      }
    })
  );
};

const getPath = (itemId, fs) => {
    let path = '';
    let currentItem = fs[itemId];
    while (currentItem && currentItem.parentId) {
        path = `/${currentItem.name}${path}`;
        currentItem = fs[currentItem.parentId];
    }
    return path;
};

const findItemByPath = (path, currentDir, fs) => {
    const parts = path.split('/').filter(p => p);
    let currentPathParts = currentDir.split('/').filter(p => p);

    if (!path.startsWith('/')) {
        currentPathParts.pop();
    } else {
        currentPathParts = [];
    }
    
    for (const part of parts) {
        if (part === '..') {
            currentPathParts.pop();
        } else if (part !== '.') {
            currentPathParts.push(part);
        }
    }

    const finalPath = '/' + currentPathParts.join('/');
    
    const target = Object.values(fs).find(item => getPath(item.id, fs) === finalPath);
    return target || null;
};

const Preview = ({ fileSystem }) => {
  const srcDoc = useMemo(() => {
    const rootHtmlFile = Object.values(fileSystem).find(
      (item) => item.type === ItemType.FILE && item.name.toLowerCase() === 'index.html'
    );

    if (!rootHtmlFile) {
      return '<html><body><h1>index.html not found</h1></body></html>';
    }

    let content = rootHtmlFile.content;
    const rootPath = getPath(rootHtmlFile.id, fileSystem);

    content = content.replace(/<link\s+.*?href="([^"]+)"[^>]*>/g, (match, href) => {
      const cssFile = findItemByPath(href, rootPath, fileSystem);
      if (cssFile && cssFile.type === ItemType.FILE && cssFile.name.endsWith('.css')) {
        return `<style>${cssFile.content}</style>`;
      }
      return match;
    });

    content = content.replace(/<script\s+.*?src="([^"]+)"[^>]*><\/script>/g, (match, src) => {
      const jsFile = findItemByPath(src, rootPath, fileSystem);
      if (jsFile && jsFile.type === ItemType.FILE && jsFile.name.endsWith('.js')) {
        return `<script>${jsFile.content}<\/script>`;
      }
      return match;
    });
    
    content = content.replace(/<img\s+.*?src="([^"]+)"[^>]*>/g, (match, src) => {
        const imageFile = findItemByPath(src, rootPath, fileSystem);
        if (imageFile && imageFile.type === ItemType.FILE && imageFile.name.match(/\.(png|jpg|jpeg|gif|svg)$/)) {
            const file = imageFile;
            const mimeType = `image/${file.name.split('.').pop()}`;
            const newSrc = `data:${mimeType};base64,${file.content}`;
            return match.replace(src, newSrc);
        }
        return match;
    });

    return `
      <!DOCTYPE html>
      <html>
        <head>
           <meta charset="UTF-8">
           <meta name="viewport" content="width=device-width, initial-scale=1.0">
        </head>
        <body>
          ${content}
        </body>
      </html>
    `;
  }, [fileSystem]);

  return React.createElement("iframe", {
    srcDoc: srcDoc,
    title: "preview",
    sandbox: "allow-scripts allow-modals",
    className: "w-full h-full bg-white"
  });
};

const MenuBar = () => React.createElement("div", { className: "bg-[#3c3c3c] text-neutral-300 text-sm flex items-center px-4 h-8 select-none flex-shrink-0" },
    React.createElement("div", { className: "flex space-x-4" },
        React.createElement("span", null, "File"),
        React.createElement("span", null, "Edit"),
        React.createElement("span", null, "Selection"),
        React.createElement("span", null, "View"),
        React.createElement("span", null, "Go"),
        React.createElement("span", null, "Run"),
        React.createElement("span", null, "Terminal"),
        React.createElement("span", null, "Help")
    )
);

const ExplorerItemComponent = ({ item, level, onSelect, onToggle, onRename, onDelete, onDrop, dragOverId, setDragOverId, isActive }) => {
    const [isHovered, setIsHovered] = useState(false);
    const [isEditing, setIsEditing] = useState(false);
    const [name, setName] = useState(item.name);
    
    const handleRename = () => {
        if (name.trim()) {
            onRename(item.id, name.trim());
        }
        setIsEditing(false);
    };

    const itemIcon = useMemo(() => {
        if (item.type === ItemType.FOLDER) {
            return item.isOpen ? React.createElement(FolderOpenIcon, null) : React.createElement(FolderIcon, null);
        }
        return React.createElement(FileIcon, { type: item.language, className: "w-4 h-4" });
    }, [item]);
    
    const isDragOver = dragOverId === item.id;

    const handleDragStart = (e) => {
        e.dataTransfer.setData('text/plain', item.id);
        e.dataTransfer.effectAllowed = 'move';
    };

    const handleDragOver = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setDragOverId(item.id);
    };
    
    const handleDragLeave = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setDragOverId(null);
    };

    const handleDropEvent = (e) => {
        e.preventDefault();
        e.stopPropagation();
        const draggedId = e.dataTransfer.getData('text/plain');
        onDrop(item.id, draggedId);
    };

    const getDynamicClassName = () => {
      if (isDragOver) return 'bg-[#094771]';
      if (isActive) return 'bg-[#37373d]';
      return 'hover:bg-[#37373d]';
    };

    return React.createElement("div", {
            draggable: true,
            onDragStart: handleDragStart,
            onDragOver: handleDragOver,
            onDragLeave: handleDragLeave,
            onDrop: handleDropEvent,
            onMouseEnter: () => setIsHovered(true),
            onMouseLeave: () => setIsHovered(false),
            className: `flex items-center p-1 rounded-md cursor-pointer ${getDynamicClassName()}`,
            style: { paddingLeft: `${level * 16 + 4}px` },
            onClick: () => {
                if(isEditing) return;
                item.type === ItemType.FOLDER ? onToggle(item.id) : onSelect(item.id, item.type);
            }
        },
        React.createElement("div", { className: "w-5 h-5 flex items-center justify-center mr-1" },
            item.type === ItemType.FOLDER && React.createElement(ChevronDownIcon, { className: `w-3 h-3 transition-transform ${item.isOpen ? 'rotate-0' : '-rotate-90'}` })
        ),
        itemIcon,
        isEditing ? React.createElement("input", {
            type: "text",
            value: name,
            onChange: (e) => setName(e.target.value),
            onBlur: handleRename,
            onKeyDown: (e) => e.key === 'Enter' && handleRename(),
            className: "bg-[#3c3c3c] text-white border border-blue-500 rounded-sm ml-1 px-1 flex-grow",
            autoFocus: true,
            onClick: e => e.stopPropagation()
        }) : React.createElement("span", { className: "ml-1 truncate" }, item.name),
        isHovered && !isEditing && React.createElement("div", { className: "ml-auto flex items-center space-x-1 pr-1" },
            React.createElement(EditIcon, { className: "hover:text-white", onClick: (e) => { e.stopPropagation(); setIsEditing(true); } }),
            React.createElement(DeleteIcon, { className: "hover:text-red-500", onClick: (e) => { e.stopPropagation(); onDelete(item.id); } })
        )
    );
};

const FileExplorer = ({ fileSystem, activeFileId, onSelectFile, onToggleFolder, onUpdateFileSystem }) => {
    const [dragOverId, setDragOverId] = useState(null);

    const renderTree = (parentId, level) => {
        return Object.values(fileSystem)
            .filter(item => item.parentId === parentId)
            .sort((a, b) => {
                if (a.type !== b.type) return a.type === ItemType.FOLDER ? -1 : 1;
                return a.name.localeCompare(b.name);
            })
            .flatMap(item => {
                const children = item.type === ItemType.FOLDER && item.isOpen
                    ? renderTree(item.id, level + 1)
                    : [];
                return [
                    React.createElement(ExplorerItemComponent, {
                        key: item.id,
                        item: item,
                        level: level,
                        onSelect: onSelectFile,
                        onToggle: onToggleFolder,
                        isActive: activeFileId === item.id,
                        onRename: handleRenameItem,
                        onDelete: handleDeleteItem,
                        onDrop: handleDrop,
                        dragOverId: dragOverId,
                        setDragOverId: setDragOverId,
                    }),
                    ...children
                ];
            });
    };

    const handleCreateItem = (type) => {
        const parentId = 'root'; 
        let defaultName = type === ItemType.FILE ? 'new-file.txt' : 'new-folder';
        
        let i = 1;
        while(Object.values(fileSystem).some(item => item.parentId === parentId && item.name === defaultName)) {
            defaultName = type === ItemType.FILE ? `new-file-${i}.txt` : `new-folder-${i}`;
            i++;
        }

        const name = prompt(`Enter ${type} name:`, defaultName);
        if (!name || !name.trim()) return;

        if(Object.values(fileSystem).some(item => item.parentId === parentId && item.name === name)) {
            alert(`An item named "${name}" already exists in this folder.`);
            return;
        }
        
        const newId = `${type}_${Date.now()}`;
        let newItem;

        if (type === ItemType.FILE) {
            const extension = name.split('.').pop()?.toLowerCase() || '';
            const language = Object.values(FileType).includes(extension) ? extension : FileType.JAVASCRIPT;
            newItem = { id: newId, name, parentId, type: ItemType.FILE, language, content: '' };
        } else {
            newItem = { id: newId, name, parentId, type: ItemType.FOLDER, isOpen: false };
        }

        onUpdateFileSystem({ ...fileSystem, [newId]: newItem });
    };

    const handleRenameItem = (id, newName) => {
        const item = fileSystem[id];
        if (!item || item.name === newName) return;

        if (Object.values(fileSystem).some(i => i.id !== id && i.parentId === item.parentId && i.name === newName)) {
            alert(`An item named "${newName}" already exists in this folder.`);
            return;
        }
        
        const updatedItem = { ...item, name: newName };

        if(updatedItem.type === ItemType.FILE) {
            const extension = newName.split('.').pop()?.toLowerCase() || '';
            const language = Object.values(FileType).includes(extension) ? extension : FileType.JAVASCRIPT;
            updatedItem.language = language;
        }

        onUpdateFileSystem({ ...fileSystem, [id]: updatedItem });
    };

    const handleDeleteItem = (id) => {
        if (!window.confirm(`Are you sure you want to delete "${fileSystem[id].name}"? This action cannot be undone.`)) return;
        
        const newFS = { ...fileSystem };
        const itemsToDelete = new Set();
        const queue = [id];
        itemsToDelete.add(id);

        while(queue.length > 0) {
            const currentId = queue.shift();
            if (newFS[currentId]?.type === ItemType.FOLDER) {
                Object.values(newFS).forEach(item => {
                    if (item.parentId === currentId) {
                        itemsToDelete.add(item.id);
                        queue.push(item.id);
                    }
                });
            }
        }

        itemsToDelete.forEach(deleteId => delete newFS[deleteId]);
        onUpdateFileSystem(newFS);
    };

    const isChildOf = (childId, parentId, fs) => {
      let current = fs[childId];
      if (!current) return false;
      while (current.parentId) {
          if (current.parentId === parentId) return true;
          current = fs[current.parentId];
          if (!current) return false;
      }
      return false;
    };

    const handleDrop = (droppedOnId, draggedId) => {
        setDragOverId(null);
        if (droppedOnId === draggedId) return;

        const draggedItem = fileSystem[draggedId];
        const targetItem = fileSystem[droppedOnId];
        if (!draggedItem || !targetItem) return;

        let newParentId = targetItem.type === ItemType.FOLDER ? targetItem.id : targetItem.parentId;
        if (newParentId === null) newParentId = 'root';

        if (draggedItem.type === ItemType.FOLDER && (newParentId === draggedId || isChildOf(newParentId, draggedId, fileSystem))) {
            alert("Error: Cannot move a folder into itself or one of its own subfolders.");
            return;
        }
        
        if (draggedItem.parentId === newParentId) return;
        
        if(Object.values(fileSystem).some(item => item.id !== draggedId && item.parentId === newParentId && item.name === draggedItem.name)) {
            alert(`An item named "${draggedItem.name}" already exists in the target folder.`);
            return;
        }

        const updatedItem = { ...draggedItem, parentId: newParentId };
        onUpdateFileSystem({ ...fileSystem, [draggedId]: updatedItem });
    };

    return React.createElement("div", { className: "bg-[#252526] h-full text-neutral-300 p-2 text-sm select-none flex flex-col" },
        React.createElement("div", { className: "flex items-center justify-between mb-2 p-1" },
            React.createElement("span", { className: "font-bold" }, "EXPLORER"),
            React.createElement("div", { className: "flex items-center space-x-2 text-neutral-400" },
                React.createElement(NewFileIcon, { className: "w-5 h-5 hover:text-white", onClick: () => handleCreateItem(ItemType.FILE) }),
                React.createElement(NewFolderIcon, { className: "w-5 h-5 hover:text-white", onClick: () => handleCreateItem(ItemType.FOLDER) })
            )
        ),
        React.createElement("div", { className: "flex-grow overflow-y-auto", onDrop: e => { e.preventDefault(); handleDrop('root', e.dataTransfer.getData('text/plain'))}, onDragOver: e => e.preventDefault() },
            renderTree('root', 0)
        )
    );
};

const FileTabs = ({ files, activeFileId, onSelectFile, onCloseTab }) => React.createElement("div", { className: "flex bg-[#252526] flex-shrink-0" },
    files.map(file => file && React.createElement("div", {
            key: file.id,
            onClick: () => onSelectFile(file.id),
            className: `flex items-center justify-between p-2 text-sm cursor-pointer border-t-2 ${activeFileId === file.id ? 'bg-[#1e1e1e] text-white border-blue-500' : 'text-neutral-400 border-transparent hover:bg-[#37373d]'}`
        },
        React.createElement(FileIcon, { type: file.language, className: "w-4 h-4 mr-2" }),
        React.createElement("span", { className: "pr-2" }, file.name),
        React.createElement(CloseIcon, { className: "w-5 h-5 p-0.5 rounded hover:bg-[#3f3f42]", onClick: (e) => { e.stopPropagation(); onCloseTab(file.id); }})
    ))
);

const StatusBar = () => React.createElement("div", { className: "bg-[#007acc] text-white text-xs flex items-center justify-between px-4 h-6 select-none flex-shrink-0" },
    React.createElement("div", null, "Ready"),
    React.createElement("div", { className: "flex items-center space-x-4" },
        React.createElement("span", null, "UTF-8"),
        React.createElement("span", null, "LF"),
        React.createElement("span", null, "015x.dev")
    )
);

const App = () => {
  const [fileSystem, setFileSystem] = useState(INITIAL_FILE_SYSTEM);
  const [openFileIds, setOpenFileIds] = useState(['index.html']);
  const [activeFileId, setActiveFileId] = useState('index.html');
  const [isResizing, setIsResizing] = useState(false);
  
  const activeFile = useMemo(() => {
    if (!activeFileId || fileSystem[activeFileId]?.type !== ItemType.FILE) return null;
    return fileSystem[activeFileId];
  }, [activeFileId, fileSystem]);

  const handleFileContentChange = (fileId, newContent) => {
    setFileSystem(prevFS => {
      const file = prevFS[fileId];
      if (file && file.type === ItemType.FILE) {
        return { ...prevFS, [fileId]: { ...file, content: newContent }};
      }
      return prevFS;
    });
  };

  const debouncedFileSystem = useDebounce(fileSystem, 500);

  const handleSelectFile = (id, type) => {
    if (type === ItemType.FILE) {
      if (!openFileIds.includes(id)) {
        setOpenFileIds(prev => [...prev, id]);
      }
      setActiveFileId(id);
    }
  };

  const handleToggleFolder = (id) => {
    setFileSystem(prevFS => {
        const folder = prevFS[id];
        if (folder && folder.type === ItemType.FOLDER) {
            return { ...prevFS, [id]: { ...folder, isOpen: !folder.isOpen }};
        }
        return prevFS;
    });
  };
  
  const handleCloseTab = (idToClose) => {
    const newOpenFileIds = openFileIds.filter(id => id !== idToClose);
    setOpenFileIds(newOpenFileIds);

    if (activeFileId === idToClose) {
        setActiveFileId(newOpenFileIds.length > 0 ? newOpenFileIds[newOpenFileIds.length - 1] : null);
    }
  };
  
  const handleUpdateFileSystem = (newFS) => {
    const existingIds = new Set(Object.keys(newFS));
    const newOpenFileIds = openFileIds.filter(id => existingIds.has(id));
    
    if (newOpenFileIds.length < openFileIds.length) {
       setOpenFileIds(newOpenFileIds);
    }

    if(activeFileId && !existingIds.has(activeFileId)){
        setActiveFileId(newOpenFileIds.length > 0 ? newOpenFileIds[newOpenFileIds.length - 1] : null);
    }
    setFileSystem(newFS);
  }

  const openFiles = useMemo(() => openFileIds.map(id => fileSystem[id]).filter(Boolean), [openFileIds, fileSystem]);

  return React.createElement("div", { className: "flex flex-col h-screen w-screen overflow-hidden text-white font-sans" },
    React.createElement(MenuBar, null),
    React.createElement("div", { className: "flex flex-grow overflow-hidden" },
      React.createElement(ResizablePanel, { 
            direction: "horizontal", 
            initialSize: 20, 
            minSize: 15, 
            maxSize: 40,
            onResizeStart: () => setIsResizing(true),
            onResizeEnd: () => setIsResizing(false)
        },
        React.createElement(FileExplorer, { 
            fileSystem: fileSystem, 
            activeFileId: activeFileId, 
            onSelectFile: handleSelectFile,
            onToggleFolder: handleToggleFolder,
            onUpdateFileSystem: handleUpdateFileSystem
        }),
        React.createElement("div", { className: "h-full flex flex-col overflow-hidden min-w-0" },
          React.createElement(FileTabs, { files: openFiles, activeFileId: activeFileId, onSelectFile: setActiveFileId, onCloseTab: handleCloseTab }),
          React.createElement("div", { className: "flex-grow overflow-hidden" },
            React.createElement(ResizablePanel, { 
                direction: "horizontal", 
                initialSize: 50, 
                minSize: 20, 
                maxSize: 80,
                onResizeStart: () => setIsResizing(true),
                onResizeEnd: () => setIsResizing(false)
            },
              React.createElement("div", { className: "h-full w-full bg-[#1e1e1e]" },
                activeFile ? React.createElement(CodeEditor, {
                    key: activeFile.id,
                    language: activeFile.language,
                    value: activeFile.content,
                    onChange: newContent => handleFileContentChange(activeFile.id, newContent)
                }) : React.createElement("div", { className: "flex items-center justify-center h-full text-neutral-500" }, "Select a file to begin editing")
              ),
              React.createElement("div", { className: `h-full w-full bg-white ${isResizing ? 'pointer-events-none' : ''}` },
                React.createElement(Preview, { fileSystem: debouncedFileSystem })
              )
            )
          )
        )
      )
    ),
    React.createElement(StatusBar, null)
  );
};

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}
const root = ReactDOM.createRoot(rootElement);
root.render(
  React.createElement(React.StrictMode, null, 
    React.createElement(App, null)
  )
);
    </script>
  </body>
</html>
