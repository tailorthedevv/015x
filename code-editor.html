<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z'%3E%3C/path%3E%3Cpolyline points='14 2 14 8 20 8'%3E%3C/polyline%3E%3C/svg%3E" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>015x.dev Editor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              vs: {
                bg: 'var(--vs-bg)',
                sidebar: 'var(--vs-sidebar)',
                activityBar: 'var(--vs-activity-bar)',
                activeTab: 'var(--vs-active-tab)',
                inactiveTab: 'var(--vs-inactive-tab)',
                border: 'var(--vs-border)',
                accent: 'var(--vs-accent)',
                text: 'var(--vs-text)',
                textHover: 'var(--vs-text-hover)',
                itemHover: 'var(--vs-item-hover)',
                itemActive: 'var(--vs-item-active)',
                inputBg: 'var(--vs-input-bg)',
                danger: '#ef4444',
                success: '#22c55e',
                warning: '#eab308'
              }
            },
            fontSize: {
              xxs: '0.65rem'
            },
            fontFamily: {
              sans: ['"Segoe UI"', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif'],
              mono: ['"Fira Code"', '"Consolas"', '"Monaco"', 'monospace']
            },
            animation: {
                'slide-in': 'slideIn 0.2s ease-out forwards',
                'fade-in': 'fadeIn 0.2s ease-out forwards'
            },
            keyframes: {
                slideIn: {
                    '0%': { opacity: '0', transform: 'translateY(-10px)' },
                    '100%': { opacity: '1', transform: 'translateY(0)' },
                },
                fadeIn: {
                    '0%': { opacity: '0' },
                    '100%': { opacity: '1' }
                }
            }
          }
        }
      }
    </script>

    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for Dependencies -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "@monaco-editor/react": "https://esm.sh/@monaco-editor/react@4.6.0?deps=react@18.2.0,react-dom@18.2.0",
        "lucide-react": "https://esm.sh/lucide-react@0.330.0?deps=react@18.2.0",
        "jszip": "https://esm.sh/jszip@3.10.1",
        "prettier": "https://esm.sh/prettier@3.2.5/standalone",
        "prettier/plugins/estree": "https://esm.sh/prettier@3.2.5/plugins/estree",
        "prettier/parser-html": "https://esm.sh/prettier@3.2.5/plugins/html",
        "prettier/parser-babel": "https://esm.sh/prettier@3.2.5/plugins/babel",
        "prettier/parser-postcss": "https://esm.sh/prettier@3.2.5/plugins/postcss",
        "clsx": "https://esm.sh/clsx@2.1.0",
        "tailwind-merge": "https://esm.sh/tailwind-merge@2.2.1"
      }
    }
    </script>

    <style>
      :root {
        /* Default Dark Theme Variables */
        --vs-bg: #1e1e1e;
        --vs-sidebar: #252526;
        --vs-activity-bar: #333333;
        --vs-active-tab: #1e1e1e;
        --vs-inactive-tab: #2d2d2d;
        --vs-border: #454545;
        --vs-accent: #007acc;
        --vs-text: #cccccc;
        --vs-text-hover: #ffffff;
        --vs-item-hover: #2a2d2e;
        --vs-item-active: #37373d;
        --vs-input-bg: #3c3c3c;
      }
      
      body {
        background-color: var(--vs-bg);
        color: var(--vs-text);
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-corner {
        background: var(--vs-bg);
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--vs-border);
        border-radius: 5px;
        border: 2px solid transparent; /* Creates padding around thumb */
        background-clip: content-box;
      }
      ::-webkit-scrollbar-thumb:hover {
        background-color: var(--vs-text);
      }

      /* Form Elements Global Styling */
      select, input[type="text"], input[type="search"] {
        background-color: var(--vs-input-bg);
        color: var(--vs-text);
        border-color: var(--vs-border);
      }
      
      select:focus, input:focus {
        border-color: var(--vs-accent);
        outline: none;
      }
      
      option {
        background-color: var(--vs-input-bg);
        color: var(--vs-text);
      }

      /* Range Input */
      input[type="range"] {
         -webkit-appearance: none;
         background: transparent;
      }
      input[type="range"]::-webkit-slider-thumb {
         -webkit-appearance: none;
         height: 12px;
         width: 12px;
         border-radius: 50%;
         background: var(--vs-accent);
         cursor: pointer;
         margin-top: -4px;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        cursor: pointer;
        background: var(--vs-border);
        border-radius: 2px;
      }
    </style>
  </head>
  <body class="overflow-hidden h-screen w-screen m-0 select-none">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        /**
         * 015x.dev Editor - Compiled Single File
         * Includes all logic, styles, and components.
         */

        import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import Editor, { OnMount } from '@monaco-editor/react';
        import { 
            FileCode2, FileJson, FileType2, FileImage, File, Folder, FolderOpen, 
            ChevronRight, ChevronDown, Plus, Trash2, Edit2, Settings, 
            Search, Layers, Play, Download, Upload, RefreshCw, X, Menu,
            Code2, LayoutTemplate, MoreVertical, Terminal, XCircle, AlertTriangle, 
            Info, Maximize, Minimize, Palette, Type, Layout, Code, Zap, BookOpen, 
            CheckCircle2, FilePlus, FolderPlus
        } from 'lucide-react';
        import JSZip from 'jszip';
        import { format } from 'prettier';
        import pluginEstree from 'prettier/plugins/estree';
        import parserHtml from 'prettier/parser-html';
        import parserBabel from 'prettier/parser-babel';
        import parserPostcss from 'prettier/parser-postcss';

        // --- TYPES ---
        
        enum FileType {
          HTML = 'html',
          CSS = 'css',
          JAVASCRIPT = 'javascript',
          JSON = 'json',
          MARKDOWN = 'markdown',
          PNG = 'png',
          UNKNOWN = 'unknown',
        }

        enum ItemType {
          FILE = 'file',
          FOLDER = 'folder',
        }

        // Interfaces are erased by Babel, but kept here for clarity if this were a TS file
        /*
        interface FileSystemItem {
          id: string;
          name: string;
          parentId: string | null;
          type: ItemType;
          content?: string;
          language?: FileType;
          isOpen?: boolean;
        }
        interface FileSystem { [id: string]: FileSystemItem; }
        */

        // --- CONSTANTS ---

        const INITIAL_FILE_SYSTEM = {
          'root': { id: 'root', name: 'project', parentId: null, type: ItemType.FOLDER, isOpen: true },
          'src': { id: 'src', name: 'src', parentId: 'root', type: ItemType.FOLDER, isOpen: true },
          'index.html': { 
            id: 'index.html', 
            name: 'index.html', 
            parentId: 'root',
            type: ItemType.FILE,
            language: FileType.HTML,
            content: `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>015x.dev Editor</title>
    <link rel="stylesheet" href="src/style.css">
</head>
<body>
    <div class="container">
        <h1>Welcome to 015x.dev Editor</h1>
        <p>Edit files, format code, and download your project!</p>
        <button id="actionBtn">Click Me</button>
        <div id="output"></div>
    </div>
    <script src="src/script.js"><\/script>
</body>
</html>`
          },
          'style.css': {
            id: 'style.css',
            name: 'style.css',
            parentId: 'src',
            type: ItemType.FILE,
            language: FileType.CSS,
            content: `body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #1e1e1e;
    color: #e0e0e0;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

.container {
    text-align: center;
    background: #252526;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    border: 1px solid #333;
}

h1 {
    color: #61dafb;
    margin-bottom: 1rem;
}

button {
    background-color: #007acc;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.2s;
}

button:hover {
    background-color: #0062a3;
}

#output {
    margin-top: 1rem;
    color: #4ec9b0;
    min-height: 1.5rem;
}`
          },
          'script.js': {
            id: 'script.js',
            name: 'script.js',
            parentId: 'src',
            type: ItemType.FILE,
            language: FileType.JAVASCRIPT,
            content: `console.log("System initialized...");

const btn = document.getElementById('actionBtn');
const output = document.getElementById('output');

btn.addEventListener('click', () => {
    console.log("Button clicked at " + new Date().toLocaleTimeString());
    output.textContent = "Action executed successfully!";
    
    // Animate button
    btn.style.transform = "scale(0.95)";
    setTimeout(() => {
        btn.style.transform = "scale(1)";
    }, 100);
});`
          },
          'README.md': {
            id: 'README.md',
            name: 'README.md',
            parentId: 'root',
            type: ItemType.FILE,
            language: FileType.MARKDOWN,
            content: `# 015x.dev Editor Project

This is a sample project created with the 015x.dev Editor.

## Features
- **Monaco Editor**: Industry standard code editing.
- **File System**: Create folders and files.
- **Live Preview**: See changes instantly.
- **Export**: Download your project as a ZIP.
`
          }
        };

        const DEFAULT_SETTINGS = {
          fontSize: 14,
          wordWrap: 'on',
          minimap: true,
          tabSize: 2,
          lineNumbers: 'on',
          cursorStyle: 'line',
          fontLigatures: true,
          cursorBlinking: 'smooth',
          smoothScrolling: true,
          cursorSmoothCaretAnimation: 'on'
        };

        const THEMES = [
          {
            id: 'vs-dark',
            name: 'Visual Studio Dark',
            type: 'dark',
            colors: {
              bg: '#1e1e1e',
              sidebar: '#252526',
              activityBar: '#333333',
              activeTab: '#1e1e1e',
              inactiveTab: '#2d2d2d',
              border: '#454545',
              accent: '#007acc',
              text: '#cccccc',
              textHover: '#ffffff',
              itemHover: '#2a2d2e',
              itemActive: '#37373d',
              inputBg: '#3c3c3c',
            },
            monaco: { 
                base: 'vs-dark', 
                inherit: true, 
                rules: [
                    { token: 'comment', foreground: '6A9955' },
                    { token: 'keyword', foreground: '569CD6' },
                    { token: 'string', foreground: 'CE9178' },
                    { token: 'number', foreground: 'B5CEA8' },
                    { token: 'type', foreground: '4EC9B0' },
                    { token: 'class', foreground: '4EC9B0' },
                    { token: 'function', foreground: 'DCDCAA' },
                    { token: 'variable', foreground: '9CDCFE' }
                ], 
                colors: { 'editor.background': '#1e1e1e' } 
            }
          },
          {
            id: 'vs-light',
            name: 'Visual Studio Light',
            type: 'light',
            colors: {
              bg: '#ffffff',
              sidebar: '#f3f3f3',
              activityBar: '#2c2c2c',
              activeTab: '#ffffff',
              inactiveTab: '#ececec',
              border: '#e7e7e7',
              accent: '#007acc',
              text: '#333333',
              textHover: '#000000',
              itemHover: '#e8e8e8',
              itemActive: '#ffffff',
              inputBg: '#ffffff',
            },
            monaco: { 
                base: 'vs', 
                inherit: true, 
                rules: [
                    { token: 'comment', foreground: '008000' },
                    { token: 'keyword', foreground: '0000ff' },
                    { token: 'string', foreground: 'a31515' },
                    { token: 'number', foreground: '098658' }
                ], 
                colors: { 'editor.background': '#ffffff' } 
            }
          },
          {
            id: 'github-dark',
            name: 'GitHub Dark',
            type: 'dark',
            colors: {
              bg: '#0d1117',
              sidebar: '#010409',
              activityBar: '#0d1117',
              activeTab: '#0d1117',
              inactiveTab: '#010409',
              border: '#30363d',
              accent: '#58a6ff',
              text: '#c9d1d9',
              textHover: '#58a6ff',
              itemHover: '#161b22',
              itemActive: '#1f2428',
              inputBg: '#0d1117',
            },
            monaco: {
              base: 'vs-dark',
              inherit: true,
              rules: [
                { token: 'comment', foreground: '8b949e' },
                { token: 'keyword', foreground: 'ff7b72' },
                { token: 'string', foreground: 'a5d6ff' },
                { token: 'number', foreground: '79c0ff' },
                { token: 'type', foreground: '79c0ff' },
                { token: 'class', foreground: 'f0883e' },
                { token: 'function', foreground: 'd2a8ff' },
              ],
              colors: {
                'editor.background': '#0d1117',
                'editor.foreground': '#c9d1d9',
                'editorLineNumber.foreground': '#8b949e',
                'editor.lineHighlightBackground': '#161b22',
                'editorCursor.foreground': '#58a6ff'
              }
            }
          },
          {
            id: 'github-light',
            name: 'GitHub Light',
            type: 'light',
            colors: {
              bg: '#ffffff',
              sidebar: '#f6f8fa',
              activityBar: '#ffffff',
              activeTab: '#ffffff',
              inactiveTab: '#f6f8fa',
              border: '#d0d7de',
              accent: '#0969da',
              text: '#24292f',
              textHover: '#0969da',
              itemHover: '#f3f4f6',
              itemActive: '#ffffff',
              inputBg: '#ffffff',
            },
            monaco: {
              base: 'vs',
              inherit: true,
              rules: [
                { token: 'comment', foreground: '6e7781' },
                { token: 'keyword', foreground: 'cf222e' },
                { token: 'string', foreground: '0a3069' },
                { token: 'number', foreground: '0550ae' },
                { token: 'type', foreground: '0550ae' },
                { token: 'class', foreground: '953800' },
                { token: 'function', foreground: '8250df' },
              ],
              colors: {
                'editor.background': '#ffffff',
                'editor.foreground': '#24292f',
                'editorLineNumber.foreground': '#8c959f',
                'editorCursor.foreground': '#0969da'
              }
            }
          },
          {
            id: 'monokai',
            name: 'Monokai',
            type: 'dark',
            colors: {
              bg: '#272822',
              sidebar: '#1e1f1c',
              activityBar: '#171814',
              activeTab: '#272822',
              inactiveTab: '#1e1f1c',
              border: '#3e3d32',
              accent: '#a6e22e',
              text: '#f8f8f2',
              textHover: '#ffffff',
              itemHover: '#3e3d32',
              itemActive: '#49483e',
              inputBg: '#49483e',
            },
            monaco: {
              base: 'vs-dark',
              inherit: true,
              rules: [
                { token: 'comment', foreground: '75715e' },
                { token: 'keyword', foreground: 'f92672' },
                { token: 'string', foreground: 'e6db74' },
                { token: 'number', foreground: 'ae81ff' },
                { token: 'type', foreground: '66d9ef' },
                { token: 'class', foreground: 'a6e22e' },
                { token: 'function', foreground: 'a6e22e' },
              ],
              colors: {
                'editor.background': '#272822',
                'editor.foreground': '#f8f8f2',
                'editorLineNumber.foreground': '#90908a',
                'editorCursor.foreground': '#f8f8f0'
              }
            }
          },
          {
            id: 'dracula',
            name: 'Dracula',
            type: 'dark',
            colors: {
              bg: '#282a36',
              sidebar: '#21222c',
              activityBar: '#191a21',
              activeTab: '#282a36',
              inactiveTab: '#21222c',
              border: '#44475a',
              accent: '#bd93f9',
              text: '#f8f8f2',
              textHover: '#ffffff',
              itemHover: '#44475a',
              itemActive: '#6272a4',
              inputBg: '#282a36',
            },
            monaco: {
              base: 'vs-dark',
              inherit: true,
              rules: [
                { token: 'comment', foreground: '6272a4' },
                { token: 'keyword', foreground: 'ff79c6' },
                { token: 'string', foreground: 'f1fa8c' },
                { token: 'number', foreground: 'bd93f9' },
                { token: 'type', foreground: '8be9fd' },
                { token: 'class', foreground: '50fa7b' },
                { token: 'function', foreground: '50fa7b' },
                { token: 'variable', foreground: 'f8f8f2' }
              ],
              colors: {
                'editor.background': '#282a36',
                'editor.foreground': '#f8f8f2',
                'editorLineNumber.foreground': '#6272a4',
                'editorCursor.foreground': '#f8f8f0',
                'editor.selectionBackground': '#44475a'
              }
            }
          },
          {
            id: 'nord',
            name: 'Nord',
            type: 'dark',
            colors: {
              bg: '#2e3440',
              sidebar: '#2e3440',
              activityBar: '#3b4252',
              activeTab: '#3b4252',
              inactiveTab: '#2e3440',
              border: '#434c5e',
              accent: '#88c0d0',
              text: '#d8dee9',
              textHover: '#eceff4',
              itemHover: '#434c5e',
              itemActive: '#4c566a',
              inputBg: '#3b4252',
            },
            monaco: {
              base: 'vs-dark',
              inherit: true,
              rules: [
                { token: 'comment', foreground: '616e88' },
                { token: 'keyword', foreground: '81a1c1' },
                { token: 'string', foreground: 'a3be8c' },
                { token: 'number', foreground: 'b48ead' },
                { token: 'type', foreground: '8fbcbb' },
                { token: 'class', foreground: '8fbcbb' },
                { token: 'function', foreground: '88c0d0' },
              ],
              colors: {
                'editor.background': '#2e3440',
                'editor.foreground': '#d8dee9',
                'editorLineNumber.foreground': '#4c566a',
                'editorCursor.foreground': '#d8dee9',
                'editor.selectionBackground': '#434c5e'
              }
            }
          },
          {
            id: 'solarized-dark',
            name: 'Solarized Dark',
            type: 'dark',
            colors: {
              bg: '#002b36',
              sidebar: '#073642',
              activityBar: '#002b36',
              activeTab: '#002b36',
              inactiveTab: '#073642',
              border: '#586e75',
              accent: '#268bd2',
              text: '#839496',
              textHover: '#93a1a1',
              itemHover: '#586e75',
              itemActive: '#657b83',
              inputBg: '#073642',
            },
            monaco: {
              base: 'vs-dark',
              inherit: true,
              rules: [
                { token: 'comment', foreground: '586e75' },
                { token: 'keyword', foreground: '859900' },
                { token: 'string', foreground: '2aa198' },
                { token: 'number', foreground: 'd33682' },
                { token: 'type', foreground: 'b58900' },
                { token: 'class', foreground: 'b58900' },
                { token: 'function', foreground: '268bd2' },
              ],
              colors: {
                'editor.background': '#002b36',
                'editor.foreground': '#839496',
                'editorLineNumber.foreground': '#586e75',
                'editorCursor.foreground': '#d33682',
                'editor.selectionBackground': '#073642'
              }
            }
          },
          {
            id: 'solarized-light',
            name: 'Solarized Light',
            type: 'light',
            colors: {
              bg: '#fdf6e3',
              sidebar: '#eee8d5',
              activityBar: '#fdf6e3',
              activeTab: '#fdf6e3',
              inactiveTab: '#eee8d5',
              border: '#93a1a1',
              accent: '#268bd2',
              text: '#657b83',
              textHover: '#586e75',
              itemHover: '#d33682',
              itemActive: '#ffffff',
              inputBg: '#fdf6e3',
            },
            monaco: {
              base: 'vs',
              inherit: true,
              rules: [
                { token: 'comment', foreground: '93a1a1' },
                { token: 'keyword', foreground: '859900' },
                { token: 'string', foreground: '2aa198' },
                { token: 'number', foreground: 'd33682' },
                { token: 'type', foreground: 'b58900' },
                { token: 'class', foreground: 'b58900' },
                { token: 'function', foreground: '268bd2' },
              ],
              colors: {
                'editor.background': '#fdf6e3',
                'editor.foreground': '#657b83',
                'editorLineNumber.foreground': '#93a1a1',
                'editorCursor.foreground': '#657b83'
              }
            }
          },
          {
            id: 'one-dark-pro',
            name: 'One Dark Pro',
            type: 'dark',
            colors: {
              bg: '#282c34',
              sidebar: '#21252b',
              activityBar: '#21252b',
              activeTab: '#282c34',
              inactiveTab: '#21252b',
              border: '#181a1f',
              accent: '#61afef',
              text: '#abb2bf',
              textHover: '#ffffff',
              itemHover: '#2c313a',
              itemActive: '#3e4451',
              inputBg: '#282c34',
            },
            monaco: {
              base: 'vs-dark',
              inherit: true,
              rules: [
                { token: 'comment', foreground: '5c6370' },
                { token: 'keyword', foreground: 'c678dd' },
                { token: 'string', foreground: '98c379' },
                { token: 'number', foreground: 'd19a66' },
                { token: 'type', foreground: 'e5c07b' },
                { token: 'class', foreground: 'e5c07b' },
                { token: 'function', foreground: '61afef' },
                { token: 'variable', foreground: 'abb2bf' }
              ],
              colors: {
                'editor.background': '#282c34',
                'editor.foreground': '#abb2bf',
                'editorLineNumber.foreground': '#4b5263',
                'editorCursor.foreground': '#528bff',
                'editor.selectionBackground': '#3e4451'
              }
            }
          }
        ];

        const GAME_DEV_LESSON = {
          title: "Intro to Game Dev",
          description: "Learn to build a simple bouncing box loop.",
          level: "Beginner",
          total_sections: 4,
          sections: [
            {
              section_id: 1,
              title: "1. Setup Canvas",
              objective: "Get the drawing context from the HTML element.",
              theory: "We need to select the <canvas> element and get its '2d' context, which gives us tools to draw.",
              steps: [
                "Select the canvas element by ID.",
                "Get the '2d' context.",
                "Set canvas size to window size."
              ],
              code_snippet: `const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;`
            },
            {
              section_id: 2,
              title: "2. Draw a Box",
              objective: "Draw a simple colored rectangle.",
              theory: "The coordinate system starts at top-left (0,0). Positive Y goes down.",
              steps: [
                "Set a fill color.",
                "Draw a rectangle at (x, y, width, height)."
              ],
              code_snippet: `// Set Color
ctx.fillStyle = 'cyan';

// Draw Rectangle: x=100, y=100, w=50, h=50
ctx.fillRect(100, 100, 50, 50);`
            },
            {
              section_id: 3,
              title: "3. The Game Loop",
              objective: "Make things change over time.",
              theory: "A game loop clears the screen and redraws everything multiple times a second.",
              steps: [
                "Create a loop function.",
                "Clear the screen.",
                "Draw.",
                "Request next frame."
              ],
              code_snippet: `let x = 100;

function loop() {
  // 1. Clear Screen
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 2. Update Position
  x = x + 2;

  // 3. Draw
  ctx.fillStyle = 'cyan';
  ctx.fillRect(x, 100, 50, 50);

  // 4. Repeat
  requestAnimationFrame(loop);
}

loop();`
            },
            {
              section_id: 4,
              title: "4. Bouncing Logic",
              objective: "Make the box bounce off walls.",
              theory: "We use a velocity variable. If the box hits a wall, we flip the velocity direction.",
              steps: [
                "Add velocity variable.",
                "Check boundary collisions.",
                "Reverse velocity if hit."
              ],
              code_snippet: `let x = 100;
let speed = 5;

function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Check boundaries
  if (x > canvas.width || x < 0) {
     speed = -speed;
  }

  x += speed;

  ctx.fillStyle = 'cyan';
  ctx.fillRect(x, 100, 50, 50);
  
  requestAnimationFrame(loop);
}

loop();`
            }
          ]
        };

        // --- UTILS ---

        const getPath = (itemId, fs) => {
          let path = '';
          let currentItem = fs[itemId];
          while (currentItem && currentItem.parentId) {
            path = `/${currentItem.name}${path}`;
            currentItem = fs[currentItem.parentId];
          }
          return path || '/'; // Return / for root
        };

        const findItemByPath = (path, currentDir, fs) => {
          // Normalize path separators
          path = path.replace(/\\/g, '/');
          
          // Handle absolute paths
          let absolutePath = '';
          if (path.startsWith('/')) {
              absolutePath = path;
          } else {
              // Resolve relative path
              const dirParts = currentDir === '/' ? [] : currentDir.split('/').filter(Boolean);
              const pathParts = path.split('/').filter(Boolean);
              
              for (const part of pathParts) {
                  if (part === '.') continue;
                  if (part === '..') {
                      dirParts.pop();
                  } else {
                      dirParts.push(part);
                  }
              }
              absolutePath = '/' + dirParts.join('/');
          }

          // Search in FileSystem
          for (const key in fs) {
              if (getPath(key, fs) === absolutePath) {
                  return fs[key];
              }
          }

          return null;
        };

        const resolveLanguage = (fileName) => {
          const ext = fileName.split('.').pop()?.toLowerCase();
          switch (ext) {
            case 'html': return FileType.HTML;
            case 'css': return FileType.CSS;
            case 'js':
            case 'jsx':
            case 'ts':
            case 'tsx': return FileType.JAVASCRIPT;
            case 'json': return FileType.JSON;
            case 'md': return FileType.MARKDOWN;
            case 'png':
            case 'jpg':
            case 'jpeg':
            case 'gif': return FileType.PNG;
            default: return FileType.UNKNOWN;
          }
        };

        const formatCode = async (code, language) => {
          try {
            let parser = '';
            let plugins = [];

            switch (language) {
              case FileType.HTML:
                parser = 'html';
                plugins = [parserHtml, parserPostcss, parserBabel]; // Babel needed for inline scripts
                break;
              case FileType.CSS:
                parser = 'css';
                plugins = [parserPostcss];
                break;
              case FileType.JAVASCRIPT:
              case FileType.JSON:
                parser = 'babel';
                plugins = [parserBabel, pluginEstree]; // estree is critical for babel
                break;
              default:
                return code;
            }

            return await format(code, {
              parser,
              plugins,
              printWidth: 80,
              tabWidth: 2,
              semi: true,
              singleQuote: true,
            });
          } catch (e) {
            console.error('Formatting failed', e);
            return code;
          }
        };

        const exportProjectToZip = async (fs) => {
          const zip = new JSZip();

          Object.values(fs).forEach(item => {
            if (item.type === ItemType.FILE && item.content !== undefined) {
              const path = getPath(item.id, fs);
              const zipPath = path.startsWith('/') ? path.slice(1) : path;
              
              if (item.language === FileType.PNG) {
                 zip.file(zipPath, item.content, { base64: true });
              } else {
                 zip.file(zipPath, item.content);
              }
            }
          });

          const content = await zip.generateAsync({ type: 'blob' });
          const url = window.URL.createObjectURL(content);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'project.zip';
          a.click();
          window.URL.revokeObjectURL(url);
        };

        const processImport = async (file) => {
            try {
                const zip = await JSZip.loadAsync(file);
                const newFS = {
                    'root': { id: 'root', name: 'project', parentId: null, type: ItemType.FOLDER, isOpen: true }
                };

                const promises = [];

                zip.forEach((relativePath, zipEntry) => {
                    promises.push(new Promise(async (resolve) => {
                        if (zipEntry.dir) {
                            // Create folders path
                            const parts = relativePath.split('/').filter(Boolean);
                            let currentParentId = 'root';
                            
                            parts.forEach((part, index) => {
                                // Check if exists
                                const existingId = Object.keys(newFS).find(key => 
                                    newFS[key].name === part && newFS[key].parentId === currentParentId
                                );

                                if (existingId) {
                                    currentParentId = existingId;
                                } else {
                                    const newId = `folder_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                                    newFS[newId] = {
                                        id: newId,
                                        name: part,
                                        parentId: currentParentId,
                                        type: ItemType.FOLDER,
                                        isOpen: true // Open by default
                                    };
                                    currentParentId = newId;
                                }
                            });
                        } else {
                            // Handle File
                            const content = await zipEntry.async('string'); // Assuming text for now, could detect binary
                            const parts = relativePath.split('/');
                            const fileName = parts.pop() || 'unknown';
                            const dirParts = parts.filter(Boolean);
                            
                            // Recreate directory structure if it doesn't exist
                             let currentParentId = 'root';
                             dirParts.forEach((part) => {
                                 const existingId = Object.keys(newFS).find(key => 
                                    newFS[key].name === part && newFS[key].parentId === currentParentId
                                );
                                 if(existingId) {
                                     currentParentId = existingId;
                                 } else {
                                     const newId = `folder_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                                     newFS[newId] = { id: newId, name: part, parentId: currentParentId, type: ItemType.FOLDER, isOpen: true };
                                     currentParentId = newId;
                                 }
                             });

                            const fileId = `file_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                            const language = resolveLanguage(fileName);
                            
                            newFS[fileId] = {
                                id: fileId,
                                name: fileName,
                                parentId: currentParentId,
                                type: ItemType.FILE,
                                language: language,
                                content: content
                            };
                        }
                        resolve();
                    }));
                });

                await Promise.all(promises);
                return newFS;

            } catch (error) {
                console.error("Failed to import zip", error);
                alert("Failed to read the ZIP file.");
                return null;
            }
        };

        // --- COMPONENTS ---

        // Icon Helper
        const getFileIcon = (type, className) => {
          const props = { className: className || "w-4 h-4" };
          switch (type) {
            case FileType.HTML: return <Code2 {...props} className={`${props.className} text-orange-500`} />;
            case FileType.CSS: return <FileType2 {...props} className={`${props.className} text-blue-400`} />;
            case FileType.JAVASCRIPT: return <FileCode2 {...props} className={`${props.className} text-yellow-400`} />;
            case FileType.JSON: return <FileJson {...props} className={`${props.className} text-yellow-200`} />;
            case FileType.PNG: return <FileImage {...props} className={`${props.className} text-purple-400`} />;
            case FileType.MARKDOWN: return <File {...props} className={`${props.className} text-gray-400`} />;
            default: return <File {...props} className="text-gray-400" />;
          }
        };

        // Explorer Item
        const ExplorerItem = ({ 
          item, 
          level, 
          activeFileId, 
          onSelectFile,
          onToggleFolder,
          onCreateItem,
          onDeleteItem,
          onRenameItem,
          onMoveItem
        }) => {
          const [isEditing, setIsEditing] = useState(false);
          const [name, setName] = useState(item.name);
          const [isHovered, setIsHovered] = useState(false);

          const handleRename = () => {
            if (name.trim() && name !== item.name) {
              onRenameItem(item.id, name.trim());
            } else {
                setName(item.name); 
            }
            setIsEditing(false);
          };

          const handleDragStart = (e) => {
              e.dataTransfer.setData('text/plain', item.id);
          };

          const handleDragOver = (e) => {
              e.preventDefault();
          };

          const handleDrop = (e) => {
              e.preventDefault();
              e.stopPropagation();
              const draggedId = e.dataTransfer.getData('text/plain');
              onMoveItem(draggedId, item.id);
          };

          const isFolder = item.type === ItemType.FOLDER;
          const isRoot = item.id === 'root';
          const isActive = activeFileId === item.id;
          
          // Root usually isn't shown in list, but we handle it in parent
          if (isRoot) return null; 

          return (
            <div
              className={`group flex items-center select-none cursor-pointer text-sm py-1 pr-2 transition-colors
                ${isActive ? 'bg-vs-itemActive text-white' : 'text-vs-text hover:bg-vs-itemHover hover:text-vs-textHover'}
              `}
              style={{ paddingLeft: `${level * 12 + 10}px` }}
              onClick={(e) => {
                  e.stopPropagation(); // Important!
                  if (!isEditing) isFolder ? onToggleFolder(item.id) : onSelectFile(item.id);
              }}
              draggable={!isEditing}
              onDragStart={handleDragStart}
              onDragOver={handleDragOver}
              onDrop={handleDrop}
              onMouseEnter={() => setIsHovered(true)}
              onMouseLeave={() => setIsHovered(false)}
            >
              <div className="mr-1 opacity-80 shrink-0">
                {isFolder ? (
                  item.isOpen ? <ChevronDown size={14} /> : <ChevronRight size={14} />
                ) : (
                  <span className="w-3.5 inline-block" />
                )}
              </div>
              
              <div className="mr-2 opacity-100 shrink-0">
                {isFolder ? (
                    item.isOpen ? <FolderOpen size={16} className="text-vs-accent" /> : <Folder size={16} className="text-vs-accent" />
                ) : (
                    getFileIcon(item.language, "w-4 h-4")
                )}
              </div>

              {isEditing ? (
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  onBlur={handleRename}
                  onKeyDown={(e) => e.key === 'Enter' && handleRename()}
                  className="bg-vs-activityBar border border-vs-accent text-white px-1 py-0 outline-none w-full min-w-0 h-5 text-xs"
                  autoFocus
                  onClick={(e) => e.stopPropagation()}
                />
              ) : (
                <span className="truncate flex-1 py-0.5">{item.name}</span>
              )}

              {isHovered && !isEditing && (
                <div className="flex items-center space-x-1 ml-2 opacity-100 transition-opacity">
                    {isFolder && (
                        <>
                            <FilePlus size={12} className="hover:text-white text-neutral-400" onClick={(e) => { e.stopPropagation(); onCreateItem(ItemType.FILE, item.id); }} title="New File in Folder" />
                            <FolderPlus size={12} className="hover:text-white text-neutral-400" onClick={(e) => { e.stopPropagation(); onCreateItem(ItemType.FOLDER, item.id); }} title="New Folder in Folder" />
                        </>
                    )}
                    <Edit2 size={12} className="hover:text-white text-neutral-400" onClick={(e) => { e.stopPropagation(); setIsEditing(true); }} title="Rename" />
                    <Trash2 size={12} className="hover:text-vs-danger text-neutral-400" onClick={(e) => { e.stopPropagation(); onDeleteItem(item.id); }} title="Delete" />
                </div>
              )}
            </div>
          );
        };

        // Explorer
        const Explorer = (props) => {
          const { fileSystem } = props;

          const renderTree = (parentId, level) => {
            return Object.values(fileSystem)
              .filter(item => item.parentId === parentId)
              .sort((a, b) => {
                if (a.type !== b.type) return a.type === ItemType.FOLDER ? -1 : 1;
                return a.name.localeCompare(b.name);
              })
              .map(item => (
                <React.Fragment key={item.id}>
                  <ExplorerItem {...props} item={item} level={level} />
                  {item.type === ItemType.FOLDER && item.isOpen && renderTree(item.id, level + 1)}
                </React.Fragment>
              ));
          };

          return (
            <div className="h-full flex flex-col bg-vs-sidebar text-vs-text border-r border-vs-border select-none">
                <div className="h-9 px-3 flex items-center justify-between text-xs font-bold tracking-wide uppercase text-neutral-400 shrink-0 border-b border-vs-border">
                    <span>Explorer</span>
                    <div className="flex items-center space-x-2">
                        <FilePlus size={14} className="hover:text-white cursor-pointer" onClick={() => props.onCreateItem(ItemType.FILE, 'root')} title="New File at Root" />
                        <FolderPlus size={14} className="hover:text-white cursor-pointer" onClick={() => props.onCreateItem(ItemType.FOLDER, 'root')} title="New Folder at Root" />
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto overflow-x-hidden custom-scrollbar py-2">
                    {renderTree('root', 0)}
                </div>
            </div>
          );
        };

        // Code Editor
        const CodeEditor = ({ 
          file, 
          settings, 
          theme,
          ghostText,
          onChange, 
          onFormat,
          onSave
        }) => {
          const editorRef = React.useRef(null);
          const monacoRef = React.useRef(null);
          const [contentLeft, setContentLeft] = useState(62);

          const handleEditorDidMount = (editor, monaco) => {
            editorRef.current = editor;
            monacoRef.current = monaco;

            monaco.editor.defineTheme(theme.id, {
                base: theme.monaco.base,
                inherit: theme.monaco.inherit,
                rules: theme.monaco.rules,
                colors: theme.monaco.colors
            });
            monaco.editor.setTheme(theme.id);

            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KeyF, () => {
              onFormat();
            });
            
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
               onSave();
            });

            editor.onDidLayoutChange((e) => {
                setContentLeft(e.contentLeft);
            });
            setContentLeft(editor.getLayoutInfo().contentLeft);
          };

          useEffect(() => {
              if (monacoRef.current && theme) {
                  monacoRef.current.editor.defineTheme(theme.id, {
                      base: theme.monaco.base,
                      inherit: theme.monaco.inherit,
                      rules: theme.monaco.rules,
                      colors: theme.monaco.colors
                  });
                  monacoRef.current.editor.setTheme(theme.id);
              }
          }, [theme]);

          useEffect(() => {
            if (editorRef.current) {
                editorRef.current.layout();
            }
          }, [settings.fontSize, settings.minimap, settings.wordWrap]);

          if (!file) {
            return (
              <div className="h-full w-full bg-vs-bg flex flex-col items-center justify-center text-vs-text select-none animate-fade-in">
                <div className="bg-vs-activityBar p-6 rounded-full mb-6 shadow-lg">
                     <div className="w-12 h-12 bg-vs-accent rounded opacity-50"></div>
                </div>
                <p className="text-xl font-medium mb-3">No file is open</p>
                <p className="text-sm opacity-60 mb-8">Select a file from the explorer or create a new one.</p>
                
                <div className="grid grid-cols-2 gap-x-8 gap-y-4 text-xs opacity-50">
                     <div className="text-right">Save</div>
                     <div className="font-mono bg-vs-activityBar px-2 py-0.5 rounded border border-vs-border">Ctrl + S</div>
                     
                     <div className="text-right">Format</div>
                     <div className="font-mono bg-vs-activityBar px-2 py-0.5 rounded border border-vs-border">Ctrl + Shift + F</div>
                     
                     <div className="text-right">Command Palette</div>
                     <div className="font-mono bg-vs-activityBar px-2 py-0.5 rounded border border-vs-border">F1</div>
                </div>
              </div>
            );
          }

          const overlayStyle = {
              fontFamily: "'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace",
              fontSize: `${settings.fontSize}px`,
              lineHeight: '21px', 
              paddingTop: '16px', 
              paddingLeft: `${contentLeft}px`, 
              tabSize: settings.tabSize,
              whiteSpace: settings.wordWrap === 'on' ? 'pre-wrap' : 'pre',
              width: '100%',
              boxSizing: 'border-box'
          };

          return (
            <div className="h-full w-full bg-vs-bg relative group animate-fade-in overflow-hidden">
              {ghostText && (
                  <div 
                    className="absolute inset-0 z-10 pointer-events-none text-vs-text opacity-40 select-none overflow-hidden"
                    style={overlayStyle}
                  >
                      {ghostText}
                  </div>
              )}

              <Editor
                height="100%"
                language={file.language || 'plaintext'}
                value={file.content || ''}
                onChange={(value) => onChange(value || '')}
                onMount={handleEditorDidMount}
                options={{
                  minimap: { enabled: settings.minimap, scale: 0.75 },
                  fontSize: settings.fontSize,
                  lineHeight: 21,
                  fontFamily: "'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace",
                  fontLigatures: settings.fontLigatures,
                  wordWrap: settings.wordWrap,
                  tabSize: settings.tabSize,
                  lineNumbers: settings.lineNumbers,
                  cursorStyle: settings.cursorStyle,
                  cursorBlinking: settings.cursorBlinking,
                  smoothScrolling: settings.smoothScrolling,
                  cursorSmoothCaretAnimation: settings.cursorSmoothCaretAnimation,
                  scrollBeyondLastLine: false,
                  padding: { top: 16 },
                  renderLineHighlight: 'all',
                  automaticLayout: true,
                  formatOnPaste: true,
                  formatOnType: true,
                }}
              />
              <button 
                onClick={onFormat}
                className="absolute top-4 right-6 z-20 p-2 bg-vs-activityBar text-vs-text hover:text-white rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity border border-vs-border"
                title="Format Document"
              >
                <RefreshCw size={14} />
              </button>
            </div>
          );
        };

        // Preview
        const Preview = ({ fileSystem, refreshTrigger }) => {
          const iframeRef = useRef(null);
          const containerRef = useRef(null);
          const [logs, setLogs] = useState([]);
          const [showConsole, setShowConsole] = useState(false);
          const [isFullscreen, setIsFullscreen] = useState(false);

          useEffect(() => {
             setLogs([]);
          }, [refreshTrigger]);

          const toggleFullscreen = () => {
            if (!containerRef.current) return;

            if (!document.fullscreenElement) {
                containerRef.current.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
          };

          useEffect(() => {
            const handleFsChange = () => {
                setIsFullscreen(document.fullscreenElement === containerRef.current);
            };
            document.addEventListener('fullscreenchange', handleFsChange);
            return () => document.removeEventListener('fullscreenchange', handleFsChange);
          }, []);

          const srcDoc = useMemo(() => {
            const items = Object.values(fileSystem);
            const rootHtmlFile = items.find(
              (item) => item.type === ItemType.FILE && item.name.toLowerCase() === 'index.html' && item.parentId === 'root'
            ) || items.find(
                (item) => item.type === ItemType.FILE && item.name.toLowerCase() === 'index.html'
            );

            if (!rootHtmlFile || typeof rootHtmlFile.content !== 'string') {
              return `<html><body style="background:#1e1e1e;color:#888;font-family:sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;">
                <div style="text-align:center">
                    <h3>No index.html found</h3>
                    <p>Create an index.html file to start previewing.</p>
                </div>
              </body></html>`;
            }

            let content = rootHtmlFile.content;
            const rootPath = getPath(rootHtmlFile.id, fileSystem);
            const currentDir = rootPath.substring(0, rootPath.lastIndexOf('/')) || '/';

            const consoleInterceptor = `
              <script>
                (function(){
                    const oldLog = console.log;
                    const oldError = console.error;
                    const oldWarn = console.warn;
                    const oldInfo = console.info;

                    function send(type, args) {
                        try {
                            const message = args.map(arg => 
                                typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                            ).join(' ');
                            window.parent.postMessage({ type: 'CONSOLE_LOG', logType: type, message, timestamp: Date.now() }, '*');
                        } catch(e) {}
                    }

                    console.log = function(...args) { oldLog.apply(console, args); send('log', args); };
                    console.error = function(...args) { oldError.apply(console, args); send('error', args); };
                    console.warn = function(...args) { oldWarn.apply(console, args); send('warn', args); };
                    console.info = function(...args) { oldInfo.apply(console, args); send('info', args); };
                    
                    window.onerror = function(msg, url, line) {
                       send('error', [msg + " (" + line + ")"]);
                    }
                })();
              <\/script>
            `;

            content = content.replace(/<link\s+.*?href="([^"]+)"[^>]*>/g, (match, href) => {
              const cssFile = findItemByPath(href, currentDir, fileSystem);
              if (cssFile && cssFile.content) {
                return `<style>${cssFile.content}</style>`;
              }
              return match;
            });

            content = content.replace(/<script\s+.*?src="([^"]+)"[^>]*><\/script>/g, (match, src) => {
              const jsFile = findItemByPath(src, currentDir, fileSystem);
              if (jsFile && jsFile.content) {
                return `<script>${jsFile.content}<\/script>`;
              }
              return match;
            });
            
            content = content.replace(/<img\s+.*?src="([^"]+)"[^>]*>/g, (match, src) => {
                 const imgFile = findItemByPath(src, currentDir, fileSystem);
                 if (imgFile && imgFile.content && imgFile.language === FileType.PNG) {
                     return match.replace(src, `data:image/png;base64,${imgFile.content}`);
                 }
                 return match;
            });

            return content.replace('<head>', `<head>${consoleInterceptor}`);
          }, [fileSystem, refreshTrigger]);

          useEffect(() => {
              const handler = (event) => {
                  if (event.data && event.data.type === 'CONSOLE_LOG') {
                      setLogs(prev => [...prev, {
                          type: event.data.logType,
                          message: event.data.message,
                          timestamp: event.data.timestamp
                      }]);
                  }
              };
              window.addEventListener('message', handler);
              return () => window.removeEventListener('message', handler);
          }, []);

          return (
            <div ref={containerRef} className="h-full w-full flex flex-col bg-white relative group">
              <div className="absolute top-3 right-3 z-20 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                <button
                    onClick={toggleFullscreen}
                    className="p-2 bg-[#252526] text-white rounded-md shadow-lg hover:bg-[#007acc] transition-colors border border-[#3e3e42]"
                    title={isFullscreen ? "Exit Fullscreen" : "Fullscreen Preview"}
                >
                    {isFullscreen ? <Minimize size={16} /> : <Maximize size={16} />}
                </button>
              </div>

              <iframe
                ref={iframeRef}
                srcDoc={srcDoc}
                title="preview"
                sandbox="allow-scripts allow-modals allow-forms allow-same-origin"
                className="flex-1 w-full h-full border-none bg-white"
              />
              
              <div 
                className={`absolute bottom-0 left-0 right-0 bg-vs-sidebar border-t border-vs-border transition-all duration-300 ease-in-out flex flex-col ${showConsole ? 'h-48' : 'h-8'}`}
              >
                <div 
                    className="h-8 bg-vs-activityBar flex items-center px-4 justify-between cursor-pointer hover:bg-[#3e3e42]"
                    onClick={() => setShowConsole(!showConsole)}
                >
                    <div className="flex items-center space-x-2 text-xs font-bold text-neutral-300">
                        <Terminal size={14} />
                        <span>Console</span>
                        <span className="bg-neutral-600 px-1.5 rounded-full text-[10px]">{logs.length}</span>
                    </div>
                    {logs.length > 0 && (
                        <button 
                            className="p-1 hover:bg-neutral-600 rounded text-neutral-400 hover:text-white"
                            onClick={(e) => { e.stopPropagation(); setLogs([]); }}
                            title="Clear Console"
                        >
                            <XCircle size={14} />
                        </button>
                    )}
                </div>
                
                {showConsole && (
                    <div className="flex-1 overflow-y-auto p-2 font-mono text-xs space-y-1 custom-scrollbar bg-[#1e1e1e]">
                        {logs.length === 0 ? (
                            <div className="text-neutral-500 italic px-2">No output to display</div>
                        ) : (
                            logs.map((log, i) => (
                                <div key={i} className={`flex items-start space-x-2 px-2 py-0.5 border-b border-[#2d2d2d] ${
                                    log.type === 'error' ? 'text-red-400 bg-red-900/10' : 
                                    log.type === 'warn' ? 'text-yellow-400 bg-yellow-900/10' : 
                                    'text-neutral-300'
                                }`}>
                                     <span className="mt-0.5 shrink-0">
                                         {log.type === 'error' ? <XCircle size={12} /> : 
                                          log.type === 'warn' ? <AlertTriangle size={12} /> : 
                                          <Info size={12} />}
                                     </span>
                                     <span className="break-all whitespace-pre-wrap">{log.message}</span>
                                     <span className="ml-auto text-neutral-600 text-[10px] shrink-0">{new Date(log.timestamp).toLocaleTimeString()}</span>
                                </div>
                            ))
                        )}
                    </div>
                )}
              </div>
            </div>
          );
        };

        // Search Pane
        const SearchPane = ({ fileSystem, onSelectFile }) => {
          const [query, setQuery] = useState('');

          const results = useMemo(() => {
            if (!query.trim()) return [];
            
            const results = [];
            const lowerQuery = query.toLowerCase();

            Object.values(fileSystem).forEach(item => {
                if (item.type === ItemType.FILE && item.content) {
                    const matches = [];
                    
                    const lines = item.content.split('\n');
                    lines.forEach((line, index) => {
                        if (line.toLowerCase().includes(lowerQuery)) {
                            matches.push({ line: index + 1, text: line.trim() });
                        }
                    });

                    if (matches.length > 0 || item.name.toLowerCase().includes(lowerQuery)) {
                        results.push({
                            fileId: item.id,
                            fileName: item.name,
                            language: item.language,
                            matches
                        });
                    }
                }
            });
            return results;
          }, [fileSystem, query]);

          return (
            <div className="h-full flex flex-col bg-vs-sidebar text-vs-text border-r border-vs-border">
              <div className="h-9 px-3 flex items-center text-xs font-bold tracking-wide uppercase text-neutral-400 shrink-0">
                <span>Search</span>
              </div>
              <div className="px-3 pb-2">
                 <div className="relative">
                    <input 
                        type="text" 
                        placeholder="Search files" 
                        value={query}
                        onChange={e => setQuery(e.target.value)}
                        className="w-full bg-vs-activityBar border border-vs-border text-white text-xs px-2 py-1 focus:border-vs-accent outline-none"
                        autoFocus
                    />
                    <Search size={14} className="absolute right-2 top-1.5 text-neutral-500" />
                 </div>
              </div>
              <div className="flex-1 overflow-y-auto custom-scrollbar">
                 {query && results.length === 0 && (
                     <div className="text-xs text-neutral-500 text-center mt-4">No results found</div>
                 )}
                 {results.map(res => (
                     <div key={res.fileId} className="mb-1">
                         <div 
                            onClick={() => onSelectFile(res.fileId)}
                            className="flex items-center px-3 py-1 cursor-pointer hover:bg-vs-itemHover bg-vs-activityBar/30 sticky top-0"
                         >
                            <div className="mr-2">
                                {getFileIcon(res.language)}
                            </div>
                            <span className="text-xs font-bold text-neutral-300">{res.fileName}</span>
                            <span className="ml-auto text-[10px] bg-vs-accent px-1.5 rounded-full text-white">{res.matches.length}</span>
                         </div>
                         <div>
                            {res.matches.map((match, idx) => (
                                <div 
                                    key={idx}
                                    onClick={() => onSelectFile(res.fileId)}
                                    className="px-3 py-1 cursor-pointer hover:bg-vs-itemHover text-xs flex group"
                                >
                                    <span className="text-neutral-500 w-6 shrink-0 text-right mr-2 font-mono group-hover:text-vs-text">{match.line}</span>
                                    <span className="truncate text-neutral-400 group-hover:text-white font-mono">{match.text}</span>
                                </div>
                            ))}
                         </div>
                     </div>
                 ))}
              </div>
            </div>
          );
        };

        // Settings Pane
        const SettingsPane = ({ 
          settings, 
          currentThemeId, 
          onUpdateSettings, 
          onUpdateTheme,
        }) => {
          return (
            <div className="h-full flex flex-col bg-vs-sidebar text-vs-text border-r border-vs-border animate-slide-in">
              <div className="h-9 px-3 flex items-center text-xs font-bold tracking-wide uppercase text-neutral-400 shrink-0 border-b border-vs-border">
                <span>Settings</span>
              </div>
              
              <div className="flex-1 overflow-y-auto p-4 space-y-6 custom-scrollbar">
                
                <section>
                  <div className="flex items-center space-x-2 text-xs font-bold uppercase text-vs-accent mb-3">
                     <Palette size={14} />
                     <span>Appearance</span>
                  </div>
                  <div className="space-y-3 bg-vs-activityBar/30 p-3 rounded border border-vs-border">
                     <div>
                        <label className="block text-xs mb-1 text-neutral-400">Color Theme</label>
                        <select 
                          value={currentThemeId} 
                          onChange={(e) => onUpdateTheme(e.target.value)}
                          className="w-full rounded-sm p-1.5 text-xs border"
                        >
                          {THEMES.map(theme => (
                            <option key={theme.id} value={theme.id}>{theme.name}</option>
                          ))}
                        </select>
                     </div>

                     <div className="flex items-center justify-between">
                        <label className="text-xs text-neutral-400">Font Ligatures</label>
                        <input 
                          type="checkbox" 
                          checked={settings.fontLigatures}
                          onChange={(e) => onUpdateSettings({ fontLigatures: e.target.checked })}
                          className="accent-vs-accent"
                        />
                     </div>
                  </div>
                </section>

                <section>
                  <div className="flex items-center space-x-2 text-xs font-bold uppercase text-vs-accent mb-3">
                     <Code size={14} />
                     <span>Editor</span>
                  </div>
                  <div className="space-y-3 bg-vs-activityBar/30 p-3 rounded border border-vs-border">
                     <div>
                        <label className="block text-xs mb-1 text-neutral-400">Font Size: {settings.fontSize}px</label>
                        <input 
                          type="range" 
                          min="10" 
                          max="24" 
                          value={settings.fontSize}
                          onChange={(e) => onUpdateSettings({ fontSize: parseInt(e.target.value) })}
                          className="w-full"
                        />
                     </div>

                     <div className="grid grid-cols-2 gap-3">
                         <div>
                            <label className="block text-xs mb-1 text-neutral-400">Tab Size</label>
                            <select 
                              value={settings.tabSize}
                              onChange={(e) => onUpdateSettings({ tabSize: parseInt(e.target.value) })}
                              className="w-full rounded-sm p-1.5 text-xs border"
                            >
                              <option value={2}>2 Spaces</option>
                              <option value={4}>4 Spaces</option>
                              <option value={8}>8 Spaces</option>
                            </select>
                         </div>
                         <div>
                            <label className="block text-xs mb-1 text-neutral-400">Word Wrap</label>
                            <select 
                              value={settings.wordWrap}
                              onChange={(e) => onUpdateSettings({ wordWrap: e.target.value })}
                              className="w-full rounded-sm p-1.5 text-xs border"
                            >
                              <option value="on">On</option>
                              <option value="off">Off</option>
                            </select>
                         </div>
                     </div>
                     
                     <div className="grid grid-cols-2 gap-3">
                         <div>
                            <label className="block text-xs mb-1 text-neutral-400">Cursor Style</label>
                            <select 
                              value={settings.cursorStyle}
                              onChange={(e) => onUpdateSettings({ cursorStyle: e.target.value })}
                              className="w-full rounded-sm p-1.5 text-xs border"
                            >
                              <option value="line">Line</option>
                              <option value="block">Block</option>
                              <option value="underline">Underline</option>
                            </select>
                         </div>
                         <div>
                            <label className="block text-xs mb-1 text-neutral-400">Line Numbers</label>
                            <select 
                              value={settings.lineNumbers}
                              onChange={(e) => onUpdateSettings({ lineNumbers: e.target.value })}
                              className="w-full rounded-sm p-1.5 text-xs border"
                            >
                              <option value="on">On</option>
                              <option value="off">Off</option>
                              <option value="relative">Relative</option>
                            </select>
                         </div>
                     </div>

                     <div className="flex items-center justify-between pt-2">
                        <label className="text-xs text-neutral-400">Minimap</label>
                        <input 
                          type="checkbox" 
                          checked={settings.minimap}
                          onChange={(e) => onUpdateSettings({ minimap: e.target.checked })}
                          className="accent-vs-accent"
                        />
                     </div>
                  </div>
                </section>
                
                <section>
                  <div className="flex items-center space-x-2 text-xs font-bold uppercase text-vs-accent mb-3">
                     <Zap size={14} />
                     <span>Advanced</span>
                  </div>
                  <div className="space-y-3 bg-vs-activityBar/30 p-3 rounded border border-vs-border">
                     <div>
                        <label className="block text-xs mb-1 text-neutral-400">Cursor Blinking</label>
                        <select 
                            value={settings.cursorBlinking}
                            onChange={(e) => onUpdateSettings({ cursorBlinking: e.target.value })}
                            className="w-full rounded-sm p-1.5 text-xs border"
                        >
                            <option value="blink">Blink</option>
                            <option value="smooth">Smooth</option>
                            <option value="phase">Phase</option>
                            <option value="expand">Expand</option>
                            <option value="solid">Solid</option>
                        </select>
                     </div>
                     <div className="flex items-center justify-between">
                        <label className="text-xs text-neutral-400">Smooth Scrolling</label>
                        <input 
                          type="checkbox" 
                          checked={settings.smoothScrolling}
                          onChange={(e) => onUpdateSettings({ smoothScrolling: e.target.checked })}
                          className="accent-vs-accent"
                        />
                     </div>
                     <div className="flex items-center justify-between">
                        <label className="text-xs text-neutral-400">Smooth Caret</label>
                        <input 
                          type="checkbox" 
                          checked={settings.cursorSmoothCaretAnimation === 'on'}
                          onChange={(e) => onUpdateSettings({ cursorSmoothCaretAnimation: e.target.checked ? 'on' : 'off' })}
                          className="accent-vs-accent"
                        />
                     </div>
                  </div>
                </section>

                <div className="pt-4 border-t border-vs-border">
                  <p className="text-[10px] text-neutral-500 text-center">
                    Settings & Themes are saved to session.
                  </p>
                </div>

              </div>
            </div>
          );
        };

        // Lesson Modal
        const LessonModal = ({ isOpen, onClose, onTryCode, lesson }) => {
          const [activeSectionId, setActiveSectionId] = useState(1);

          if (!isOpen) return null;

          const activeSection = lesson.sections.find(s => s.section_id === activeSectionId) || lesson.sections[0];

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in p-4">
              <div className="bg-vs-bg border border-vs-border w-full max-w-4xl max-h-[85vh] rounded-lg shadow-2xl flex flex-col overflow-hidden animate-slide-in">
                
                <div className="bg-vs-activityBar border-b border-vs-border px-6 py-4 flex items-center justify-between shrink-0">
                  <div>
                    <h2 className="text-lg font-bold text-white flex items-center">
                      <BookOpen className="mr-3 text-vs-accent" size={20} />
                      {lesson.title}
                    </h2>
                  </div>
                  <button 
                    onClick={onClose}
                    className="p-1 hover:bg-white/10 rounded-full transition-colors text-neutral-400 hover:text-white"
                  >
                    <X size={20} />
                  </button>
                </div>

                <div className="flex flex-1 overflow-hidden">
                  
                  <div className="w-1/4 min-w-[200px] bg-vs-sidebar border-r border-vs-border overflow-y-auto custom-scrollbar flex flex-col">
                    <div className="flex-1 space-y-0.5 py-2">
                      {lesson.sections.map((section) => (
                        <button
                          key={section.section_id}
                          onClick={() => setActiveSectionId(section.section_id)}
                          className={`w-full text-left px-4 py-3 flex items-center space-x-3 transition-all border-l-2
                            ${activeSectionId === section.section_id 
                              ? 'bg-vs-activeTab border-vs-accent text-white' 
                              : 'border-transparent text-neutral-400 hover:text-white hover:bg-vs-itemHover'
                            }`}
                        >
                          <div className={`w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold shrink-0 
                            ${activeSectionId === section.section_id ? 'bg-vs-accent text-white' : 'bg-vs-activityBar text-neutral-500'}`}>
                            {section.section_id}
                          </div>
                          <span className="text-sm truncate">{section.title}</span>
                        </button>
                      ))}
                    </div>
                  </div>

                  <div className="flex-1 overflow-y-auto custom-scrollbar bg-vs-bg p-8">
                    <div className="max-w-2xl mx-auto space-y-6">
                      
                      <div>
                        <h1 className="text-2xl font-bold text-white mb-2">{activeSection.title}</h1>
                        <p className="text-sm text-neutral-400">{activeSection.objective}</p>
                      </div>

                      <div className="bg-vs-activityBar/50 rounded-lg p-4 text-sm text-neutral-300 leading-relaxed border border-vs-border/50">
                         {activeSection.theory}
                      </div>

                      <div className="space-y-2">
                         <h3 className="text-sm font-bold uppercase text-neutral-500">Steps</h3>
                         <ul className="space-y-2">
                            {activeSection.steps.map((step, idx) => (
                              <li key={idx} className="flex items-start space-x-2 text-sm text-neutral-300">
                                <CheckCircle2 size={16} className="text-vs-accent mt-0.5 shrink-0" />
                                <span>{step}</span>
                              </li>
                            ))}
                         </ul>
                      </div>

                      <div className="space-y-2 pt-2">
                         <div className="flex items-center justify-between">
                            <h3 className="text-sm font-bold uppercase text-neutral-500 flex items-center">
                              <Code className="mr-2" size={14} />
                              Code
                            </h3>
                            <button 
                              onClick={() => onTryCode(activeSection.code_snippet)}
                              className="flex items-center space-x-2 text-xs bg-vs-accent hover:bg-blue-600 text-white px-3 py-1.5 rounded transition-all shadow-lg shadow-blue-900/20"
                            >
                              <Play size={12} fill="currentColor" />
                              <span>Try This</span>
                            </button>
                         </div>
                         
                         <pre className="bg-[#1e1e1e] border border-vs-border rounded-lg p-4 overflow-x-auto text-xs font-mono leading-5 text-neutral-300 shadow-inner">
                           <code>{activeSection.code_snippet}</code>
                         </pre>
                      </div>

                      <div className="flex items-center justify-between pt-6 border-t border-vs-border">
                         <button 
                            disabled={activeSectionId === 1}
                            onClick={() => setActiveSectionId(prev => Math.max(1, prev - 1))}
                            className={`text-sm ${activeSectionId === 1 ? 'text-neutral-600' : 'text-neutral-400 hover:text-white'}`}
                         >
                           Previous
                         </button>
                         
                         {activeSectionId < lesson.total_sections ? (
                           <button 
                              onClick={() => setActiveSectionId(prev => Math.min(lesson.total_sections, prev + 1))}
                              className="flex items-center text-sm text-white bg-vs-activityBar hover:bg-vs-border px-3 py-1.5 rounded"
                           >
                             Next
                             <ChevronRight size={14} className="ml-1" />
                           </button>
                         ) : (
                           <button 
                              onClick={onClose}
                              className="flex items-center text-sm text-green-400 hover:text-green-300"
                           >
                             Complete
                             <CheckCircle2 size={14} className="ml-1" />
                           </button>
                         )}
                      </div>

                    </div>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        // Help Modal
        const HelpModal = ({ isOpen, onClose }) => {
          const [activeTab, setActiveTab] = useState('shortcuts');

          if (!isOpen) return null;

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in p-4" onClick={onClose}>
              <div 
                className="bg-vs-bg border border-vs-border w-full max-w-2xl max-h-[80vh] rounded-lg shadow-2xl flex flex-col overflow-hidden animate-slide-in"
                onClick={e => e.stopPropagation()}
              >
                <div className="bg-vs-activityBar border-b border-vs-border px-6 py-4 flex items-center justify-between shrink-0">
                  <h2 className="text-lg font-bold text-white flex items-center">
                    <Info className="mr-3 text-vs-accent" size={20} />
                    Help & Documentation
                  </h2>
                  <button onClick={onClose} className="p-1 hover:bg-white/10 rounded-full transition-colors text-neutral-400 hover:text-white">
                    <X size={20} />
                  </button>
                </div>

                <div className="flex border-b border-vs-border bg-vs-sidebar">
                     <button 
                        onClick={() => setActiveTab('shortcuts')}
                        className={`px-6 py-3 text-sm font-medium transition-colors ${activeTab === 'shortcuts' ? 'text-vs-accent border-b-2 border-vs-accent bg-vs-bg' : 'text-neutral-400 hover:text-white'}`}
                     >
                        Keyboard Shortcuts
                     </button>
                     <button 
                        onClick={() => setActiveTab('about')}
                        className={`px-6 py-3 text-sm font-medium transition-colors ${activeTab === 'about' ? 'text-vs-accent border-b-2 border-vs-accent bg-vs-bg' : 'text-neutral-400 hover:text-white'}`}
                     >
                        About
                     </button>
                </div>

                <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-vs-bg">
                    {activeTab === 'shortcuts' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="space-y-4">
                                <h3 className="text-xs font-bold uppercase text-neutral-500 mb-2">General</h3>
                                <ShortcutItem keys={['Ctrl', 'S']} label="Save File" />
                                <ShortcutItem keys={['Ctrl', 'B']} label="Toggle Sidebar" />
                                <ShortcutItem keys={['Ctrl', 'Shift', 'F']} label="Format Code" />
                                <ShortcutItem keys={['F1']} label="Command Palette" />
                            </div>
                            <div className="space-y-4">
                                <h3 className="text-xs font-bold uppercase text-neutral-500 mb-2">Editor</h3>
                                <ShortcutItem keys={['Ctrl', 'F']} label="Find" />
                                <ShortcutItem keys={['Ctrl', 'H']} label="Replace" />
                                <ShortcutItem keys={['Alt', 'Up/Down']} label="Move Line" />
                                <ShortcutItem keys={['Ctrl', '/']} label="Toggle Comment" />
                            </div>
                        </div>
                    )}

                    {activeTab === 'about' && (
                        <div className="space-y-6 text-neutral-300">
                            <div className="text-center">
                                <h1 className="text-xl font-bold text-white mb-2">015x.dev Editor</h1>
                                <p className="text-sm text-neutral-400">Version 1.4.0</p>
                            </div>
                            <div className="text-sm leading-relaxed bg-vs-activityBar p-4 rounded border border-vs-border">
                                <p className="mb-2">
                                    A powerful, lightweight web-based code editor built with React and Monaco Editor.
                                    It features a full file system, live preview, themes, and interactive lessons.
                                </p>
                                <p>
                                    Designed for rapid prototyping and learning.
                                </p>
                            </div>
                            <div className="text-xs text-neutral-500 text-center">
                                Built with  by 015x.dev
                            </div>
                        </div>
                    )}
                </div>
              </div>
            </div>
          );
        };

        const ShortcutItem = ({ keys, label }) => (
            <div className="flex items-center justify-between group">
                <span className="text-sm text-neutral-300 group-hover:text-white transition-colors">{label}</span>
                <div className="flex items-center space-x-1">
                    {keys.map((k, i) => (
                        <span key={i} className="px-2 py-1 bg-vs-activityBar border border-vs-border rounded text-xs font-mono text-neutral-400 min-w-[24px] text-center shadow-sm">
                            {k}
                        </span>
                    ))}
                </div>
            </div>
        );

        // Debounce Hook
        function useDebounce(value, delay) {
          const [debouncedValue, setDebouncedValue] = useState(value);
          useEffect(() => {
            const handler = setTimeout(() => setDebouncedValue(value), delay);
            return () => clearTimeout(handler);
          }, [value, delay]);
          return debouncedValue;
        }

        // --- MAIN APP COMPONENT ---

        const App = () => {
          const [fileSystem, setFileSystem] = useState(INITIAL_FILE_SYSTEM);
          const [activeFileId, setActiveFileId] = useState('index.html');
          const [openFiles, setOpenFiles] = useState(['index.html']);
          const [sidebarWidth, setSidebarWidth] = useState(240);
          const [editorWidth, setEditorWidth] = useState(600);
          const [activeSidebarView, setActiveSidebarView] = useState('explorer');
          const [refreshTrigger, setRefreshTrigger] = useState(0);
          const [activeMenu, setActiveMenu] = useState(null);
          const [isLessonModalOpen, setIsLessonModalOpen] = useState(false);
          const [isHelpModalOpen, setIsHelpModalOpen] = useState(false);
          const [isFullscreen, setIsFullscreen] = useState(false);
          
          const [isResizing, setIsResizing] = useState(false);
          
          const [ghostText, setGhostText] = useState(null);
          
          const [settings, setSettings] = useState(DEFAULT_SETTINGS);
          const [currentThemeId, setCurrentThemeId] = useState('vs-dark');
          const fileInputRef = useRef(null);
          const styleRef = useRef(null);
          const splitPaneRef = useRef(null);
          
          const debouncedFileSystem = useDebounce(fileSystem, 800);

          const currentTheme = useMemo(() => {
              return THEMES.find(t => t.id === currentThemeId) || THEMES[0];
          }, [currentThemeId]);

          useEffect(() => {
            const root = document.documentElement;
            const colors = currentTheme.colors;
            
            if (!colors) return;

            root.style.setProperty('--vs-bg', colors.bg);
            root.style.setProperty('--vs-sidebar', colors.sidebar);
            root.style.setProperty('--vs-activity-bar', colors.activityBar);
            root.style.setProperty('--vs-active-tab', colors.activeTab);
            root.style.setProperty('--vs-inactive-tab', colors.inactiveTab);
            root.style.setProperty('--vs-border', colors.border);
            root.style.setProperty('--vs-accent', colors.accent);
            root.style.setProperty('--vs-text', colors.text);
            root.style.setProperty('--vs-text-hover', colors.textHover);
            root.style.setProperty('--vs-item-hover', colors.itemHover);
            root.style.setProperty('--vs-item-active', colors.itemActive);
            root.style.setProperty('--vs-input-bg', colors.inputBg || colors.activityBar); 
            
            if (!styleRef.current) {
                styleRef.current = document.createElement('style');
                document.head.appendChild(styleRef.current);
            }
            styleRef.current.innerHTML = currentTheme.customCss || '';

          }, [currentTheme]);

          useEffect(() => {
            const handleGlobalKeyDown = (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    console.log("Saved!"); 
                }
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'f') {
                    e.preventDefault();
                    handleFormat();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                    e.preventDefault();
                    setActiveSidebarView(prev => prev === 'hidden' ? 'explorer' : 'hidden');
                }
                if (e.key === 'F1') {
                     e.preventDefault();
                     setIsHelpModalOpen(true);
                }
            };
            window.addEventListener('keydown', handleGlobalKeyDown);
            return () => window.removeEventListener('keydown', handleGlobalKeyDown);
          }, [activeFileId, fileSystem]);

          const startSidebarResizing = useCallback((e) => {
            e.preventDefault();
            e.stopPropagation();
            setIsResizing(true);
            
            const handleMouseMove = (e) => {
               const newWidth = Math.max(180, Math.min(600, e.clientX - 48)); 
               setSidebarWidth(newWidth);
            };
            
            const handleMouseUp = () => {
               setIsResizing(false);
               document.removeEventListener('mousemove', handleMouseMove);
               document.removeEventListener('mouseup', handleMouseUp);
            };
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
          }, []);

          const startEditorResizing = useCallback((e) => {
            e.preventDefault();
            e.stopPropagation();
            setIsResizing(true);
            
            const handleMouseMove = (e) => {
               const sidebarOffset = activeSidebarView === 'hidden' ? 0 : sidebarWidth;
               const offset = 48 + sidebarOffset;
               
               const newWidth = Math.max(200, e.clientX - offset);
               setEditorWidth(newWidth);
            };
            
            const handleMouseUp = () => {
               setIsResizing(false);
               document.removeEventListener('mousemove', handleMouseMove);
               document.removeEventListener('mouseup', handleMouseUp);
               window.dispatchEvent(new Event('resize'));
            };
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
          }, [activeSidebarView, sidebarWidth]);

          const toggleFullscreen = () => {
              if (!document.fullscreenElement) {
                  document.documentElement.requestFullscreen().then(() => setIsFullscreen(true));
              } else {
                  if (document.exitFullscreen) {
                      document.exitFullscreen().then(() => setIsFullscreen(false));
                  }
              }
          };

          useEffect(() => {
              const handleFsChange = () => setIsFullscreen(!!document.fullscreenElement);
              document.addEventListener('fullscreenchange', handleFsChange);
              return () => document.removeEventListener('fullscreenchange', handleFsChange);
          }, []);

          const handleSelectFile = (id) => {
            if (!openFiles.includes(id)) {
                setOpenFiles(prev => [...prev, id]);
            }
            setActiveFileId(id);
          };

          const handleCloseFile = (e, id) => {
              e.stopPropagation();
              setOpenFiles(prev => {
                  const newOpenFiles = prev.filter(fid => fid !== id);
                  if (activeFileId === id) {
                      const lastId = newOpenFiles.length > 0 ? newOpenFiles[newOpenFiles.length - 1] : null;
                      setActiveFileId(lastId);
                  }
                  return newOpenFiles;
              });
          };
          
          const handleCloseAllFiles = () => {
              setOpenFiles([]);
              setActiveFileId(null);
          };

          const updateFileContent = (id, content) => {
            setFileSystem(prev => ({
                ...prev,
                [id]: { ...prev[id], content }
            }));
          };

          const toggleFolder = (id) => {
            setFileSystem(prev => ({
                ...prev,
                [id]: { ...prev[id], isOpen: !prev[id].isOpen }
            }));
          };

          const createItem = useCallback((type, parentId) => {
              setActiveMenu(null);
              const name = prompt(`Enter ${type} name:`);
              if (!name) return;

              const id = `${type}_${Date.now()}`;
              
              setFileSystem(prev => {
                  const siblingExists = Object.values(prev).some(
                      item => item.parentId === parentId && item.name === name
                  );
                  
                  if (siblingExists) {
                      alert("A file or folder with this name already exists in this location.");
                      return prev;
                  }

                  let language = FileType.UNKNOWN;
                  if (type === ItemType.FILE) {
                      const ext = name.split('.').pop()?.toLowerCase();
                      if (ext === 'html') language = FileType.HTML;
                      else if (ext === 'css') language = FileType.CSS;
                      else if (ext === 'js' || ext === 'ts') language = FileType.JAVASCRIPT;
                      else if (ext === 'json') language = FileType.JSON;
                      else if (ext === 'md') language = FileType.MARKDOWN;
                  }

                  const newItem = {
                      id,
                      name,
                      parentId, 
                      type,
                      content: type === ItemType.FILE ? '' : undefined,
                      language,
                      isOpen: type === ItemType.FOLDER ? true : undefined
                  };

                  const newFS = { ...prev, [id]: newItem };
                  if (parentId !== 'root' && newFS[parentId]) {
                      newFS[parentId] = { ...newFS[parentId], isOpen: true };
                  }
                  return newFS;
              });

              if (type === ItemType.FILE) {
                  setTimeout(() => {
                      setOpenFiles(prev => prev.includes(id) ? prev : [...prev, id]);
                      setActiveFileId(id);
                  }, 0);
              }
          }, []);

          const deleteItem = useCallback((id) => {
              if (!window.confirm('Are you sure you want to delete this?')) return;
              
              setFileSystem(prev => {
                  const toDelete = new Set([id]);
                  const queue = [id];
                  const items = Object.values(prev);
                  
                  while (queue.length > 0) {
                      const currentId = queue.shift();
                      items.forEach(item => {
                          if (item.parentId === currentId) {
                              toDelete.add(item.id);
                              if (item.type === ItemType.FOLDER) {
                                  queue.push(item.id);
                              }
                          }
                      });
                  }

                  const newFS = { ...prev };
                  toDelete.forEach(itemId => delete newFS[itemId]);
                  
                  setTimeout(() => {
                      setOpenFiles(currentOpen => currentOpen.filter(fid => !toDelete.has(fid)));
                      setActiveFileId(currentActive => toDelete.has(currentActive || '') ? null : currentActive);
                  }, 0);

                  return newFS;
              });
          }, []);

          const renameItem = useCallback((id, name) => {
              setFileSystem(prev => ({
                  ...prev,
                  [id]: { ...prev[id], name }
              }));
          }, []);

          const moveItem = useCallback((draggedId, targetId) => {
              if (draggedId === targetId) return;
              
              setFileSystem(prev => {
                let check = prev[targetId];
                while(check && check.parentId) {
                    if (check.parentId === draggedId) return prev; 
                    check = prev[check.parentId];
                }

                const target = prev[targetId];
                const newParentId = target.type === ItemType.FOLDER ? targetId : target.parentId;
                
                if (newParentId) {
                    return {
                        ...prev,
                        [draggedId]: { ...prev[draggedId], parentId: newParentId }
                    };
                }
                return prev;
              });
          }, []);

          const handleFormat = async () => {
              setActiveMenu(null);
              if (activeFileId) {
                  const file = fileSystem[activeFileId];
                  if (file && file.content && file.language) {
                      const formatted = await formatCode(file.content, file.language);
                      updateFileContent(activeFileId, formatted);
                  }
              }
          };

          const handleExport = () => {
              setActiveMenu(null);
              exportProjectToZip(fileSystem);
          };
          
          const handleImportClick = () => {
              setActiveMenu(null);
              fileInputRef.current?.click();
          };

          const handleImportFile = async (e) => {
              const file = e.target.files?.[0];
              if (file) {
                  const newFS = await processImport(file);
                  if (newFS) {
                      setFileSystem(newFS);
                      setOpenFiles([]);
                      setActiveFileId(null);
                      setGhostText(null);
                  }
              }
              if (fileInputRef.current) fileInputRef.current.value = '';
          };

          const updateSettings = (newSettings) => {
              setSettings(prev => ({ ...prev, ...newSettings }));
          };

          const activeFile = activeFileId ? fileSystem[activeFileId] : null;

          const lineCount = useMemo(() => {
              if (!activeFile || typeof activeFile.content !== 'string') return 0;
              return activeFile.content.split('\n').length;
          }, [activeFile]);

          const handleTryCode = (code) => {
              setIsLessonModalOpen(false);
              
              const isHtml = code.trim().startsWith('<!DOCTYPE') || code.trim().startsWith('<html');

              const newLessonFS = {
                'root': { id: 'root', name: 'lesson-project', parentId: null, type: ItemType.FOLDER, isOpen: true },
                'src': { id: 'src', name: 'src', parentId: 'root', type: ItemType.FOLDER, isOpen: true },
                'index.html': { 
                    id: 'index.html', 
                    name: 'index.html', 
                    parentId: 'root',
                    type: ItemType.FILE,
                    language: FileType.HTML,
                    content: isHtml ? '' : `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lesson</title>
    <style>body { margin: 0; overflow: hidden; background: #111; }</style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <script src="src/script.js"></script>
</body>
</html>`
                },
                'script.js': {
                    id: 'script.js',
                    name: 'script.js',
                    parentId: 'src',
                    type: ItemType.FILE,
                    language: FileType.JAVASCRIPT,
                    content: '' 
                }
              };

              setFileSystem(newLessonFS);

              const targetId = isHtml ? 'index.html' : 'script.js';
              
              setActiveFileId(targetId);
              setOpenFiles(['index.html', 'script.js']); 
              setGhostText({ fileId: targetId, content: code });
          };

          const MenuDropdown = ({ label, items, isOpen, onClick }) => (
              <div className="relative z-50">
                  <span 
                    className={`hover:text-white cursor-pointer px-2 py-1 rounded select-none ${isOpen ? 'bg-white/10 text-white' : ''}`}
                    onClick={(e) => { e.stopPropagation(); onClick(); }}
                  >
                      {label}
                  </span>
                  {isOpen && (
                      <div className="absolute top-full left-0 mt-1 w-56 bg-vs-sidebar border border-vs-border shadow-xl rounded-sm py-1">
                          {items.map((item, i) => (
                              <div 
                                key={i} 
                                className="px-4 py-1.5 hover:bg-vs-accent hover:text-white cursor-pointer flex justify-between group text-vs-text items-center"
                                onClick={(e) => { e.stopPropagation(); item.action(); setActiveMenu(null); }}
                              >
                                  <span>{item.label}</span>
                                  {item.shortcut && <span className="text-neutral-500 group-hover:text-white text-xs opacity-70 font-mono ml-4">{item.shortcut}</span>}
                              </div>
                          ))}
                      </div>
                  )}
              </div>
          );

          return (
            <div className="flex flex-col h-screen bg-vs-bg text-vs-text overflow-hidden font-sans transition-colors duration-300" onClick={() => setActiveMenu(null)}>
                {isResizing && <div className="fixed inset-0 z-50 cursor-col-resize bg-transparent"></div>}
                
                <input 
                    type="file" 
                    ref={fileInputRef} 
                    onChange={handleImportFile} 
                    accept=".zip" 
                    className="hidden" 
                />
                
                <LessonModal 
                  isOpen={isLessonModalOpen} 
                  onClose={() => setIsLessonModalOpen(false)} 
                  onTryCode={handleTryCode}
                  lesson={GAME_DEV_LESSON} 
                />
                <HelpModal 
                  isOpen={isHelpModalOpen} 
                  onClose={() => setIsHelpModalOpen(false)}
                />

                {/* Top Bar */}
                <div className="h-10 bg-vs-activityBar flex items-center justify-between px-4 border-b border-vs-border z-30 shrink-0">
                    <div className="flex items-center space-x-4">
                        <div className="font-bold text-vs-accent flex items-center mr-4">
                            <LayoutTemplate size={18} className="mr-2" />
                            015x.dev Editor
                        </div>
                        <div className="hidden md:flex items-center space-x-1 text-xs text-neutral-400">
                            <MenuDropdown 
                                label="File" 
                                isOpen={activeMenu === 'file'} 
                                onClick={() => setActiveMenu(activeMenu === 'file' ? null : 'file')}
                                items={[
                                    { label: 'New File', action: () => createItem(ItemType.FILE, 'root') },
                                    { label: 'New Folder', action: () => createItem(ItemType.FOLDER, 'root') },
                                    { label: 'Save', action: () => console.log('Saved'), shortcut: 'Ctrl+S' },
                                    { label: 'Close All', action: handleCloseAllFiles },
                                    { label: 'Import Zip', action: handleImportClick },
                                    { label: 'Download Zip', action: handleExport }
                                ]}
                            />
                            <MenuDropdown 
                                label="Edit" 
                                isOpen={activeMenu === 'edit'} 
                                onClick={() => setActiveMenu(activeMenu === 'edit' ? null : 'edit')}
                                items={[
                                    { label: 'Format Code', action: handleFormat, shortcut: 'Ctrl+Shift+F' }
                                ]}
                            />
                             <MenuDropdown 
                                label="View" 
                                isOpen={activeMenu === 'view'} 
                                onClick={() => setActiveMenu(activeMenu === 'view' ? null : 'view')}
                                items={[
                                    { label: 'Explorer', action: () => setActiveSidebarView('explorer'), shortcut: 'Ctrl+Shift+E' },
                                    { label: 'Search', action: () => setActiveSidebarView('search'), shortcut: 'Ctrl+Shift+F' },
                                    { label: 'Settings', action: () => setActiveSidebarView('settings') },
                                    { label: 'Toggle Sidebar', action: () => setActiveSidebarView(prev => prev === 'hidden' ? 'explorer' : 'hidden'), shortcut: 'Ctrl+B' }
                                ]}
                            />
                            <MenuDropdown 
                                label="Help" 
                                isOpen={activeMenu === 'help'} 
                                onClick={() => setActiveMenu(activeMenu === 'help' ? null : 'help')}
                                items={[
                                    { label: 'Documentation', action: () => setIsHelpModalOpen(true), shortcut: 'F1' },
                                    { label: 'About', action: () => setIsHelpModalOpen(true) }
                                ]}
                            />
                        </div>
                    </div>
                    
                    <div className="flex items-center space-x-3">
                         <button 
                            onClick={() => setIsLessonModalOpen(true)}
                            className="flex items-center space-x-1 px-3 py-1 bg-purple-600 hover:bg-purple-500 text-white text-xs rounded transition-colors shadow-sm"
                            title="Start Learning"
                         >
                            <GraduationCap size={14} fill="currentColor" />
                            <span>Learn</span>
                         </button>
                         <button
                            onClick={toggleFullscreen}
                            className="p-1.5 hover:bg-white/10 rounded text-neutral-400 hover:text-white transition-colors"
                            title={isFullscreen ? "Exit Fullscreen" : "Enter Fullscreen"}
                         >
                             {isFullscreen ? <Minimize size={14} /> : <Maximize size={14} />}
                         </button>
                    </div>
                </div>

                {/* Workspace */}
                <div className="flex-1 flex overflow-hidden">
                    {/* Activity Bar */}
                    <div className="w-12 bg-vs-activityBar flex flex-col items-center py-4 space-y-4 shrink-0 border-r border-vs-border z-20">
                        <div 
                            className={`p-2 rounded cursor-pointer transition-all duration-200 relative group ${activeSidebarView === 'explorer' ? 'text-vs-text' : 'text-neutral-500 hover:text-white'}`}
                            onClick={() => setActiveSidebarView(activeSidebarView === 'explorer' ? 'hidden' : 'explorer')}
                            title="Explorer (Ctrl+Shift+E)"
                        >
                            <FileCode2 size={24} strokeWidth={1.5} color={activeSidebarView === 'explorer' ? 'var(--vs-accent)' : 'currentColor'} />
                            {activeSidebarView === 'explorer' && <div className="absolute left-0 top-0 bottom-0 w-0.5 bg-vs-accent shadow-[0_0_8px_var(--vs-accent)]"></div>}
                        </div>
                        <div 
                             className={`p-2 rounded cursor-pointer transition-all duration-200 relative group ${activeSidebarView === 'search' ? 'text-vs-text' : 'text-neutral-500 hover:text-white'}`}
                             onClick={() => setActiveSidebarView(activeSidebarView === 'search' ? 'hidden' : 'search')}
                             title="Search (Ctrl+Shift+F)"
                        >
                            <Search size={24} strokeWidth={1.5} color={activeSidebarView === 'search' ? 'var(--vs-accent)' : 'currentColor'} />
                             {activeSidebarView === 'search' && <div className="absolute left-0 top-0 bottom-0 w-0.5 bg-vs-accent shadow-[0_0_8px_var(--vs-accent)]"></div>}
                        </div>
                        <div 
                            className={`mt-auto p-2 rounded cursor-pointer transition-all duration-200 relative group ${activeSidebarView === 'settings' ? 'text-vs-text' : 'text-neutral-500 hover:text-white'}`}
                            onClick={() => setActiveSidebarView(activeSidebarView === 'settings' ? 'hidden' : 'settings')}
                            title="Settings"
                        >
                            <Settings size={24} strokeWidth={1.5} color={activeSidebarView === 'settings' ? 'var(--vs-accent)' : 'currentColor'} />
                            {activeSidebarView === 'settings' && <div className="absolute left-0 top-0 bottom-0 w-0.5 bg-vs-accent shadow-[0_0_8px_var(--vs-accent)]"></div>}
                        </div>
                    </div>

                    {/* Sidebar Pane */}
                    {activeSidebarView !== 'hidden' && (
                        <div style={{ width: sidebarWidth }} className="flex flex-col shrink-0 relative border-r border-vs-border bg-vs-sidebar overflow-hidden">
                            {activeSidebarView === 'explorer' && (
                                <div className="h-full animate-slide-in">
                                     <Explorer 
                                        fileSystem={fileSystem}
                                        activeFileId={activeFileId}
                                        onSelectFile={handleSelectFile}
                                        onToggleFolder={toggleFolder}
                                        onCreateItem={createItem}
                                        onDeleteItem={deleteItem}
                                        onRenameItem={renameItem}
                                        onMoveItem={moveItem}
                                    />
                                </div>
                            )}
                            {activeSidebarView === 'search' && (
                                 <div className="h-full animate-slide-in">
                                    <SearchPane fileSystem={fileSystem} onSelectFile={handleSelectFile} />
                                </div>
                            )}
                            {activeSidebarView === 'settings' && (
                                <div className="h-full animate-slide-in">
                                    <SettingsPane 
                                        settings={settings} 
                                        currentThemeId={currentThemeId} 
                                        customTheme={null}
                                        onUpdateSettings={updateSettings} 
                                        onUpdateTheme={setCurrentThemeId} 
                                        onUpdateCustomTheme={() => {}}
                                    />
                                </div>
                            )}
                            
                            <div 
                                className="absolute top-0 right-0 w-2 h-full cursor-col-resize hover:bg-vs-accent transition-colors z-20 opacity-0 hover:opacity-100"
                                onMouseDown={startSidebarResizing}
                            />
                        </div>
                    )}

                    {/* Editor & Preview */}
                    <div className="flex-1 flex flex-col min-w-0 bg-vs-bg">
                        {/* Tabs */}
                        <div className="flex bg-vs-activityBar overflow-x-auto custom-scrollbar shrink-0 h-9">
                            {openFiles.map(id => {
                                const file = fileSystem[id];
                                if (!file) return null;
                                const isActive = activeFileId === id;
                                return (
                                    <div 
                                        key={id}
                                        className={`
                                            group flex items-center px-3 text-xs border-r border-vs-border cursor-pointer min-w-[120px] max-w-[200px] select-none
                                            ${isActive ? 'bg-vs-bg text-vs-text border-t-2 border-t-vs-accent' : 'bg-transparent text-neutral-500 hover:bg-vs-itemHover'}
                                        `}
                                        onClick={() => setActiveFileId(id)}
                                    >
                                        <span className={`mr-2 ${isActive ? 'text-vs-accent' : ''}`}>
                                            {file.language === 'html' ? '<>' : '#'}
                                        </span>
                                        <span className="truncate flex-1">{file.name}</span>
                                        <button 
                                            className={`ml-2 p-0.5 rounded-sm hover:bg-neutral-600 ${isActive ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}
                                            onClick={(e) => handleCloseFile(e, id)}
                                        >
                                            <X size={12} />
                                        </button>
                                    </div>
                                );
                            })}
                        </div>

                        {/* Split Pane */}
                        <div className="flex-1 flex overflow-hidden" ref={splitPaneRef}>
                            {/* Editor */}
                            <div 
                                style={{ width: editorWidth }}
                                className="h-full relative border-r border-vs-border"
                            >
                                <CodeEditor 
                                    file={activeFile} 
                                    settings={settings}
                                    theme={currentTheme}
                                    ghostText={ghostText?.fileId === activeFile?.id ? ghostText.content : null}
                                    onChange={(val) => activeFileId && updateFileContent(activeFileId, val)} 
                                    onFormat={handleFormat}
                                    onSave={() => console.log('Saved!')}
                                />
                            </div>
                            
                            {/* Resizer */}
                            <div 
                                className="w-2 -ml-1 h-full cursor-col-resize hover:bg-vs-accent transition-colors z-30 bg-transparent hover:opacity-100"
                                onMouseDown={startEditorResizing}
                            />

                            {/* Preview */}
                            <div className={`flex-1 h-full bg-white relative min-w-0`}>
                                <Preview fileSystem={debouncedFileSystem} refreshTrigger={refreshTrigger} />
                            </div>
                        </div>
                    </div>
                </div>
                
                {/* Footer */}
                <div className="h-6 bg-vs-accent text-white text-[10px] flex items-center px-4 justify-between select-none shrink-0 transition-colors duration-300">
                     <div className="flex items-center space-x-3">
                         <span className="flex items-center"><div className="w-2 h-2 rounded-full bg-white mr-1 animate-pulse"></div> Ready</span>
                         {activeFile && (
                             <>
                                <span>{activeFile.language?.toUpperCase()}</span>
                                <span>UTF-8</span>
                             </>
                         )}
                     </div>
                     <div className="flex items-center space-x-4">
                         <span>Ln {lineCount}</span>
                         <span>{settings.tabSize} Spaces</span>
                         <span>015x.dev Editor v1.4.0</span>
                     </div>
                </div>
            </div>
          );
        };

        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
    </script>
  </body>
</html>
